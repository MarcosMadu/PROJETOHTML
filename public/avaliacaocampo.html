<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Avaliação 5S Tecnosonda — Auditoria (Campo)</title>
  <style>
    :root{
      --bg:#f2f4f7;          /* cinza gelo */
      --card:#ffffff;
      --text:#101828;
      --muted:#667085;
      --border:#e4e7ec;
      --shadow: 0 10px 24px rgba(16,24,40,.08);
      --primary:#2563eb;
      --danger:#dc2626;
      --ok:#16a34a;
      --warn:#f59e0b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header{
      position: sticky; top:0; z-index:10;
      background: rgba(242,244,247,.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 18px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; flex-direction:column; gap:4px;
    }
    .brand h1{margin:0;font-size:18px;letter-spacing:.2px}
    .brand p{margin:0;color:var(--muted);font-size:12px}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 12px; border:1px solid var(--border); background:#fff;
      border-radius:999px; box-shadow: 0 4px 12px rgba(16,24,40,.04);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }

    main .wrap{padding-top:22px; padding-bottom:40px}

    .grid{
      display:grid; grid-template-columns: 1.2fr .8fr; gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:16px 16px 10px 16px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .card-h h2{margin:0;font-size:14px}
    .card-h .sub{margin:4px 0 0 0;font-size:12px;color:var(--muted)}
    .card-b{padding:16px}

    .meta{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px;
    }
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field input, .field select{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      outline:none;
      background:#fff;
    }
    .field input:focus, .field select:focus{
      border-color: rgba(37,99,235,.5);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .items{
      display:flex; flex-direction:column; gap:10px;
    }
    .item{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    .item-top{
      padding:12px 12px 10px 12px;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      cursor:pointer;
    }
    .item-left{display:flex; gap:10px; align-items:flex-start}
    .num{
      width:28px;height:28px;border-radius:10px;
      display:grid; place-items:center;
      border:1px solid var(--border);
      color:var(--muted); font-size:12px;
      background: #f8fafc;
      flex:0 0 auto;
    }
    .txt{min-width:0}
    .tag{
      display:inline-flex; padding:4px 8px; border-radius:999px;
      font-size:11px; border:1px solid var(--border);
      color:var(--muted); background:#fff;
      margin-bottom:6px;
    }
    .q{
      margin:0; font-size:13px; line-height:1.35;
      color: var(--text);
    }
    .chev{color:var(--muted); font-size:12px; padding-top:2px; flex:0 0 auto}

    .item-body{
      display:none;
      padding:12px;
      border-top:1px solid var(--border);
      background:#fbfcfe;
    }
    .item.open .item-body{display:block}

    .choices{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .radio{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#fff;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .radio input{margin:0}
    .note{font-size:12px;color:var(--muted);margin:0 0 10px 0}

    .panel{
      border:1px dashed rgba(102,112,133,.35);
      background:#fff;
      border-radius:14px;
      padding:12px;
      margin-top:10px;
    }
    .panel h4{margin:0 0 8px 0;font-size:12px;color:var(--text)}
    .panel .hint{margin:0 0 10px 0;font-size:12px;color:var(--muted)}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex: 1 1 220px}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border:1px solid transparent;
      padding:10px 12px; border-radius:12px;
      cursor:pointer; font-weight:600; font-size:13px;
      background: var(--primary); color:#fff;
      box-shadow: 0 10px 18px rgba(37,99,235,.18);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .btn.ghost{
      background:#fff; color:var(--text);
      border-color: var(--border);
      box-shadow:none;
      font-weight:600;
    }
    .btn.danger{
      background: var(--danger);
      box-shadow: 0 10px 18px rgba(220,38,38,.18);
    }
    .mini{
      padding:8px 10px; border-radius:10px; font-size:12px;
    }

    .deviation{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:10px;
      margin-top:10px;
    }
    .deviation .head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      font-size:11px; border:1px solid var(--border);
      color: var(--muted); background:#fff;
    }

    .footer-actions{
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      padding:14px 16px;
      border-top:1px solid var(--border);
      background: rgba(255,255,255,.7);
    }

    .alert{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:10px 12px;
      font-size:12px;
      color:var(--muted);
    }
    .alert strong{color:var(--text)}
    .loading{
      display:none; align-items:center; gap:10px;
      color:var(--muted); font-size:12px;
    }
    .loading.on{display:inline-flex}
    .dot{
      width:10px;height:10px;border-radius:999px;background:var(--primary);
      animation:pulse .9s infinite ease-in-out;
    }
    @keyframes pulse{
      0%,100%{transform:scale(.9);opacity:.6}
      50%{transform:scale(1.2);opacity:1}
    }

    /* ====== Card de maturidade (automática enquanto preenche) ====== */
    .maturidade-card{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:12px;
      box-shadow: 0 10px 18px rgba(16,24,40,.06);
      margin-bottom:14px;
    }
    .maturidade-top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .maturidade-top h3{
      margin:0;
      font-size:13px;
      color:var(--text);
    }
    .maturidade-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:12px;
      color:var(--muted);
      background:#fff;
      white-space:nowrap;
    }
    .maturidade-pill.ok{border-color: rgba(22,163,74,.35); color: var(--ok); background: rgba(22,163,74,.06)}
    .maturidade-pill.warn{border-color: rgba(245,158,11,.35); color:var(--warn); background: rgba(245,158,11,.08)}
    .maturidade-pill.danger{border-color: rgba(220,38,38,.35); color: var(--danger); background: rgba(220,38,38,.06)}
    .maturidade-body{
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      color:var(--text);
    }

    /* ====== Card RESULTADO (pós-envio) ====== */
    .resultado-card{
      display:none; /* aparece só após envio */
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 12px 22px rgba(16,24,40,.10);
      margin-bottom:14px;
      background:#fff;
      overflow:hidden;
    }
    .resultado-card.on{display:block}

    .resultado-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .resultado-head h3{
      margin:0;
      font-size:13px;
      color:var(--text);
    }
    .resultado-sub{
      margin:2px 0 0 0;
      font-size:12px;
      color:var(--muted);
    }

    .resultado-big{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
    }
    .big-num{
      font-size:56px;
      line-height:1;
      font-weight:900;
      letter-spacing:-1px;
    }
    .big-label{
      font-size:14px;
      font-weight:800;
      margin:0;
    }
    .big-desc{
      margin:6px 0 0 0;
      font-size:12px;
      color: rgba(16,24,40,.78);
    }

    /* cores por maturidade (0..4) */
    .result-0{ border-color: rgba(220,38,38,.35); background: rgba(220,38,38,.08); }
    .result-0 .big-num, .result-0 .big-label{ color: #dc2626; }

    .result-1{ border-color: rgba(249,115,22,.35); background: rgba(249,115,22,.10); }
    .result-1 .big-num, .result-1 .big-label{ color: #f97316; }

    .result-2{ border-color: rgba(245,158,11,.40); background: rgba(245,158,11,.12); }
    .result-2 .big-num, .result-2 .big-label{ color: #f59e0b; }

    .result-3{ border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.10); }
    .result-3 .big-num, .result-3 .big-label{ color: #16a34a; }

    .result-4{ border-color: rgba(37,99,235,.35); background: rgba(37,99,235,.10); }
    .result-4 .big-num, .result-4 .big-label{ color: #2563eb; }

    /* ajuste mobile */
    @media (max-width: 420px){
      .wrap{padding:14px 12px}
      .topbar{flex-direction:column; align-items:flex-start}
      .pill{white-space:normal; line-height:1.2}
      .meta{grid-template-columns:1fr}
      .btn{width:100%}
      .choices{gap:8px}
      .radio{width:100%}
      .big-num{font-size:44px}
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <h1>Avaliação 5S Tecnosonda — Campo</h1>
          <p>Auditoria semanal — Conforme / Não Conforme / Não Aplica</p>
        </div>
        <div class="pill" id="pillSemana">Semana: <strong id="semanaId">—</strong> · Auditor: <strong id="auditorSemana">—</strong></div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="grid">

        <!-- Checklist -->
        <section class="card">
          <div class="card-h">
            <div>
              <h2>Checklist (Campo)</h2>
              <p class="sub">C e NC exigem foto. NA exige justificativa. NC permite múltiplos desvios (1 foto = 1 desvio com responsável).</p>
            </div>
            <button class="btn ghost mini" id="btnExpandir">Expandir tudo</button>
          </div>

          <div class="card-b">
            <div class="items" id="listaItens"></div>

            <div class="alert">
              <strong>Validação:</strong> você só consegue enviar quando todos os itens tiverem status definido e as evidências obrigatórias estiverem anexadas.
            </div>
          </div>

          <div class="footer-actions">
            <span class="loading" id="loadingEnvio"><span class="dot"></span>Enviando inspeção...</span>
            <button class="btn" id="btnEnviar">Enviar auditoria</button>
          </div>
        </section>

        <!-- Metadados -->
        <aside class="card">
          <div class="card-h">
            <div>
              <h2>Informações do registro</h2>
              <p class="sub">Semana e auditor são automáticos (alterável no gestor).</p>
            </div>
          </div>

          <div class="card-b">

            <!-- Card RESULTADO (após envio) -->
            <div class="resultado-card" id="resultadoCard">
              <div class="resultado-head">
                <div>
                  <h3>Resultado da Auditoria</h3>
                  <p class="resultado-sub">Maturidade calculada no momento do envio</p>
                </div>
                <span class="maturidade-pill" id="resultadoPill">Enviado ✅</span>
              </div>

              <div class="resultado-big">
                <div>
                  <div class="big-num" id="resultadoNumero">—</div>
                  <p class="big-label" id="resultadoTitulo">—</p>
                  <p class="big-desc" id="resultadoDesc">—</p>
                </div>
              </div>
            </div>

            <!-- Card Maturidade (automática) -->
            <div class="maturidade-card" id="maturidadeCard">
              <div class="maturidade-top">
                <h3>Maturidade 5S (automática)</h3>
                <span class="maturidade-pill warn" id="maturidadePill">
                  Maturidade: <strong id="maturidadeValor">—</strong>
                </span>
              </div>
              <div class="maturidade-body" id="maturidadeBody">
                Preencha os status dos itens para calcular a maturidade.
              </div>
            </div>

            <div class="meta">
              <div class="field">
                <label>Data/Hora</label>
                <input id="dataHora" type="text" readonly />
              </div>
              <div class="field">
                <label>ID (gerado no envio)</label>
                <input id="auditoriaId" type="text" placeholder="—" readonly />
              </div>
              <div class="field" style="grid-column:1 / -1;">
                <label>Área / Setor (opcional)</label>
                <input id="setor" type="text" placeholder="Ex.: Frente / Pátio / Mina / Oficina..." />
              </div>
            </div>

            <div class="alert" style="margin-top:14px">
              <strong>Obs.:</strong> Conectado ao backend para buscar semana/auditor e salvar no MongoDB (com upload de fotos).
            </div>
          </div>
        </aside>

      </div>
    </div>
  </main>

  <script>
    // Lista real (auditor automático e responsável da tratativa)
    const RESPONSAVEIS = [
      "Selecione...",
      "ALLAN DO NASCIMENTO MORAES",
      "ANDRE DA CONCEICAO ALVES",
      "ANGLA RAKEL SILVA ALMEIDA",
      "ANTONY CHE GUEVARA CAVALCANTE DOS SANTOS",
      "CLEITON DE PAULA BATISTA",
      "DEIVIANE CONCEICAO PEREIRA",
      "EDUARDO DE SOUSA",
      "FERNANDO QUEIROZ DA SILVA",
      "HELIO BARBOSA DOS SANTOS",
      "HERACLITO HENRIQUE SANTANA LOPES",
      "JANAINA KETLEY ANDRADE RIBEIRO",
      "JEOVANE DOS SANTOS SILVA",
      "JORGE MOUZINHO CARVALHO",
      "LUCRECIA SANTOS DO NASCIMENTO",
      "LUIS ANTONIO FELIX DE VASCONCELLOS",
      "MARCELO MONTANDON MARCAL JUNIOR",
      "MARCOS OLIVEIRA MENEZES",
      "RAFAEL HENRIQUE ALVES RIBEIRO",
      "RAPHAEL JOSE PEREIRA DA SILVA",
      "RODRIGO BARBOSA DA SILVA",
      "MARCOS VINICUS BATISTA RIBEIRO",
      "TAINARA BERTUNES DOS SANTOS",
      "VERONICA LUIZA GOMES DE MENEZES",
      "WILDSON DA SILVA BARROS"
    ];

    // ========= ITENS (CAMPO) =========
    // Total: 17 itens (M1=1..9, M2=10..13, M3=14..15, M4=16..17)
    const ITENS = [
      // Maturidade 1 (1..9)
      { id: 1,  grupo: "Maturidade 1", texto: "O LOCAL DE TRABALHO está adequado, com recursos básicos disponíveis (Ex.: água, papel, lixeiras, copos, etc.), com mobiliários e em condições ergonômicas adequadas?" },
      { id: 2,  grupo: "Maturidade 1", texto: "Os RECURSOS NECESSÁRIOS para realização das atividades estão disponíveis, adequados, em boas condições e sem IMPROVISAÇÕES? (Ex.: EPIs, maleiros, ferramentas, materiais, etc.)" },
      { id: 3,  grupo: "Maturidade 1", texto: "A ÁREA ESTÁ LIMPA, livre de excesso de vegetação e acúmulo de materiais? (Ex.: resíduos, sucatas, peças, mato alto e andaimes não utilizados)." },
      { id: 4,  grupo: "Maturidade 1", texto: "A área está isenta de pontos de VAZAMENTO ou DERRAMAMENTO de material que possam gerar acúmulo de sujeira? (Ex.: água, óleo, minério, grãos etc.)" },
      { id: 5,  grupo: "Maturidade 1", texto: "As instalações ELÉTRICAS estão em boas condições e sem risco de choque? (Ex.: sinalizadas, organizadas, sem improvisos, sem risco de contato com pontos energizados; painéis fechados, sinalizados com carômetro e cadeado, etc.)" },
      { id: 6,  grupo: "Maturidade 1", texto: "As ESTRUTURAS estão em condições mínimas adequadas? (Ex.: riscos de quedas por aberturas no piso; estruturas deficientes; perfurações, cortes, prensamento por partes móveis/ pontiagudas sem proteção; guarda-corpos e andaimes sem placas de identificação/liberação, etc.)" },
      { id: 7,  grupo: "Maturidade 1", texto: "Existe CAMINHO SEGURO, ROTA DE FUGA e sinalização em boas condições e atualizadas? (Ex.: piso regularizado e sem obstáculos; sem bloqueio crítico impedindo acesso de resgate em emergências)." },
      { id: 8,  grupo: "Maturidade 1", texto: "Os BANHEIROS E VESTIÁRIOS disponíveis atendem as necessidades dos empregados? (Ex.: folha de controle de limpeza atualizada; sanitários compatíveis; identidade de gênero; higiene e água; iluminação, etc.)." },
      { id: 9,  grupo: "Maturidade 1", texto: "A ILUMINAÇÃO E VENTILAÇÃO/climatização estão adequadas?" },

      // Maturidade 2 (10..13)
      { id: 10, grupo: "Maturidade 2", texto: "Os RESÍDUOS perigosos e PRODUTOS QUÍMICOS estão acondicionados, identificados, possuem FDS/FISPQ e estão devidamente segregados? (Ex.: sem recipientes improvisados; baias organizadas e sinalizadas, etc.)" },
      { id: 11, grupo: "Maturidade 2", texto: "Os LOCAIS DE ARMAZENAMENTO de peças, ferramentas, materiais, insumos, matéria-prima e outros, estão definidos, organizados e identificados?" },
      { id: 12, grupo: "Maturidade 2", texto: "Existem REFERÊNCIAS VISUAIS e CONDIÇÃO NORMAL X ANORMAL em implantação na área? (Ex.: placas de sinalização; identificação e informações obrigatórias; níveis de estoque mínimo; limite de empilhamento, etc.)" },
      { id: 13, grupo: "Maturidade 2", texto: "Existe indicação visual do dono ou responsável da área, com contato e nota?" },

      // Maturidade 3 (14..15)
      { id: 14, grupo: "Maturidade 3", texto: "As referências visuais e condições normais citadas anteriormente ESTÃO IMPLANTADAS e estão SENDO RESPEITADAS pelo time de trabalho?" },
      { id: 15, grupo: "Maturidade 3", texto: "Os QUADROS DE GESTÃO VISUAL existem e estão atualizados?" },

      // Maturidade 4 (16..17)
      { id: 16, grupo: "Maturidade 4", texto: "É considerado como REFERÊNCIA DE 5S PARA AS DEMAIS ÁREAS, possui trabalhos e INICIATIVAS REGISTRADAS como boas práticas?" },
      { id: 17, grupo: "Maturidade 4", texto: "Possui pelo menos 3 meses seguidos notas de maturidade igual ou acima de 3?" }
    ];

    // Estado em memória
    const state = new Map(); // itemId -> { status, naJustificativa, conformeFotos: File[], desvios: [{foto:File, responsavel}] }

    function nowBR(){
      const d = new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    async function initSemanaMock(){
      try{
        const res = await fetch("/api/5s/semana-atual");
        if(!res.ok) throw new Error("Falha ao buscar semana atual.");
        const data = await res.json();
        document.getElementById("semanaId").textContent = data.semanaId || "—";
        document.getElementById("auditorSemana").textContent = data.auditorSemana || "—";
      }catch(e){
        document.getElementById("semanaId").textContent = "erro";
        document.getElementById("auditorSemana").textContent = "erro";
      }
    }

    function buildResponsaveisOptions(selected="Selecione..."){
      return RESPONSAVEIS.map(n => `<option value="${escapeHtml(n)}" ${n===selected?'selected':''}>${escapeHtml(n)}</option>`).join("");
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function ensureItemState(itemId){
      if(!state.has(itemId)){
        state.set(itemId, { status: null, naJustificativa:"", conformeFotos: [], desvios: [] });
      }
      return state.get(itemId);
    }

    /* ====== cálculo de maturidade (automática) ====== */
    function getItemById(id){
      return ITENS.find(x => x.id === id);
    }

    function statusLabel(s){
      if(s === "C") return "C (Conforme)";
      if(s === "NC") return "NC (Não Conforme)";
      if(s === "NA") return "NA (Não Aplica)";
      return "—";
    }

    function itemAtende(status){
      // “Atende” = C | “Neutro” = NA (não derruba) | “Não atende” = NC
      if(status === "NA") return true;
      return status === "C";
    }

    function allHaveStatus(){
      return ITENS.every(it => {
        const st = ensureItemState(it.id);
        return !!st.status;
      });
    }

    function computeMaturidade(){
      if(!allHaveStatus()){
        return { ready:false, maturidade:null, regra:"Preencha os itens para calcular.", derrubou:null };
      }

      // Faixas (campo):
      const m1 = [1,2,3,4,5,6,7,8,9];
      const m2 = [10,11,12,13];
      const m3 = [14,15];
      const m4 = [16,17];

      // 1) Se qualquer item m1 NÃO atender => maturidade 0
      for(const id of m1){
        const st = ensureItemState(id);
        if(!itemAtende(st.status)){
          const it = getItemById(id);
          return {
            ready:true,
            maturidade:0,
            regra:"Itens 1–9 (Maturidade 1): se algum NÃO atender → maturidade 0.",
            derrubou:{ id, status: st.status, texto: it?.texto || "" }
          };
        }
      }

      // 2) Se qualquer item m2 NÃO atender => maturidade 1
      for(const id of m2){
        const st = ensureItemState(id);
        if(!itemAtende(st.status)){
          const it = getItemById(id);
          return {
            ready:true,
            maturidade:1,
            regra:"Itens 10–13 (Maturidade 2): se algum NÃO atender → maturidade 1.",
            derrubou:{ id, status: st.status, texto: it?.texto || "" }
          };
        }
      }

      // 3) Se qualquer item m3 NÃO atender => maturidade 2
      for(const id of m3){
        const st = ensureItemState(id);
        if(!itemAtende(st.status)){
          const it = getItemById(id);
          return {
            ready:true,
            maturidade:2,
            regra:"Itens 14–15 (Maturidade 3): se algum NÃO atender → maturidade 2.",
            derrubou:{ id, status: st.status, texto: it?.texto || "" }
          };
        }
      }

      // 4) Se qualquer item m4 NÃO atender => maturidade 3; se ambos atenderem => 4
      for(const id of m4){
        const st = ensureItemState(id);
        if(!itemAtende(st.status)){
          const it = getItemById(id);
          return {
            ready:true,
            maturidade:3,
            regra:"Itens 16–17 (Maturidade 4): se algum NÃO atender → maturidade 3; se ambos atenderem → 4.",
            derrubou:{ id, status: st.status, texto: it?.texto || "" }
          };
        }
      }

      return {
        ready:true,
        maturidade:4,
        regra:"Todos itens atendidos nas faixas 1–9, 10–13, 14–15 e 16–17 → maturidade 4.",
        derrubou:null
      };
    }

    function updateMaturidadeCard(){
      const pill = document.getElementById("maturidadePill");
      const v = document.getElementById("maturidadeValor");
      const body = document.getElementById("maturidadeBody");

      const r = computeMaturidade();

      if(!r.ready){
        v.textContent = "—";
        pill.classList.remove("ok","danger");
        pill.classList.add("warn");
        body.innerHTML = `Preencha os status dos itens para calcular a maturidade.`;
        return;
      }

      v.textContent = String(r.maturidade);

      pill.classList.remove("ok","warn","danger");
      if(r.maturidade >= 3) pill.classList.add("ok");
      else if(r.maturidade === 2) pill.classList.add("warn");
      else pill.classList.add("danger");

      if(r.derrubou){
        body.innerHTML = `
          <div><strong>Regra aplicada:</strong> ${escapeHtml(r.regra)}</div>
          <div style="margin-top:8px">
            <strong>Item que derrubou:</strong>
            <span class="mono">#${escapeHtml(r.derrubou.id)}</span>
            (${escapeHtml(statusLabel(r.derrubou.status))})
          </div>
          <div style="margin-top:6px">
            <strong>Pergunta:</strong> ${escapeHtml(r.derrubou.texto || "—")}
          </div>
          <div style="margin-top:10px">
            <strong>Legenda:</strong> 0=inexistência · 1=fraco · 2=em implantação · 3=implantado · 4=excelência
          </div>
        `;
      }else{
        body.innerHTML = `
          <div><strong>Regra aplicada:</strong> ${escapeHtml(r.regra)}</div>
          <div style="margin-top:10px">
            <strong>Legenda:</strong> 0=inexistência · 1=fraco · 2=em implantação · 3=implantado · 4=excelência
          </div>
        `;
      }
    }

    /* ====== Card RESULTADO (pós-envio) ====== */
    function maturidadeTexto(m){
      if(m === 0) return { titulo:"Inexistência", desc:"Falhas nos itens básicos de campo. Priorize estabilizar a base (Maturidade 1)." };
      if(m === 1) return { titulo:"Fraco", desc:"Base OK, mas há gaps nos itens de organização/segregação e padronização (Maturidade 2)." };
      if(m === 2) return { titulo:"Em implantação", desc:"Padrões existem, porém ainda não sustentados/atualizados (Maturidade 3)." };
      if(m === 3) return { titulo:"Implantado", desc:"Boa consistência. Falta consolidar requisitos de referência e histórico (Maturidade 4)." };
      return { titulo:"Excelência", desc:"Área referência em 5S. Manter rotina e evidências para sustentar o padrão." };
    }

    function showResultadoMaturidade(m){
      const card = document.getElementById("resultadoCard");
      const pill = document.getElementById("resultadoPill");
      const num = document.getElementById("resultadoNumero");
      const tit = document.getElementById("resultadoTitulo");
      const des = document.getElementById("resultadoDesc");

      card.classList.remove("result-0","result-1","result-2","result-3","result-4","on");
      card.classList.add("on", `result-${m}`);

      num.textContent = String(m);

      const t = maturidadeTexto(m);
      tit.textContent = t.titulo;
      des.textContent = t.desc;

      pill.textContent = "Enviado ✅";
      card.scrollIntoView({ behavior:"smooth", block:"nearest" });
    }

    function render(){
      const container = document.getElementById("listaItens");
      container.innerHTML = "";

      ITENS.forEach((it, idx) => {
        const st = ensureItemState(it.id);

        const el = document.createElement("div");
        el.className = "item";
        el.dataset.itemId = it.id;

        el.innerHTML = `
          <div class="item-top" role="button" aria-expanded="false">
            <div class="item-left">
              <div class="num">${idx+1}</div>
              <div class="txt">
                <div class="tag">${escapeHtml(it.grupo)}</div>
                <p class="q">${escapeHtml(it.texto)}</p>
              </div>
            </div>
            <div class="chev">▼</div>
          </div>

          <div class="item-body">
            <div class="choices">
              <label class="radio">
                <input type="radio" name="status-${it.id}" value="C" ${st.status==="C"?"checked":""}/>
                Conforme (C)
              </label>
              <label class="radio">
                <input type="radio" name="status-${it.id}" value="NC" ${st.status==="NC"?"checked":""}/>
                Não Conforme (NC)
              </label>
              <label class="radio">
                <input type="radio" name="status-${it.id}" value="NA" ${st.status==="NA"?"checked":""}/>
                Não Aplica (NA)
              </label>
            </div>

            <p class="note" id="note-${it.id}">${getNoteText(st.status)}</p>

            <div id="panel-${it.id}"></div>
          </div>
        `;

        // toggle
        el.querySelector(".item-top").addEventListener("click", () => {
          const open = el.classList.toggle("open");
          el.querySelector(".item-top").setAttribute("aria-expanded", String(open));
          el.querySelector(".chev").textContent = open ? "▲" : "▼";
        });

        // status change
        el.querySelectorAll(`input[name="status-${it.id}"]`).forEach(r => {
          r.addEventListener("change", (e) => {
            st.status = e.target.value;
            if(st.status !== "NA") st.naJustificativa = "";
            if(st.status !== "C") st.conformeFotos = [];
            if(st.status !== "NC") st.desvios = [];
            updateItemPanel(it.id);
            el.querySelector(`#note-${it.id}`).textContent = getNoteText(st.status);
            updateMaturidadeCard();
          });
        });

        container.appendChild(el);
        updateItemPanel(it.id);
      });

      updateMaturidadeCard();
    }

    function getNoteText(status){
      if(status==="C") return "Foto obrigatória (evidência do item).";
      if(status==="NC") return "Foto obrigatória por desvio + responsável obrigatório por cada foto. Você pode adicionar várias NCs (vários desvios) no mesmo item.";
      if(status==="NA") return "Justificativa obrigatória para 'Não Aplica'.";
      return "Selecione um status para este item.";
    }

    function updateItemPanel(itemId){
      const st = ensureItemState(itemId);
      const panel = document.querySelector(`#panel-${CSS.escape(itemId)}`);
      if(!panel) return;

      if(!st.status){
        panel.innerHTML = "";
        return;
      }

      if(st.status === "NA"){
        panel.innerHTML = `
          <div class="panel">
            <h4>Justificativa (obrigatória)</h4>
            <p class="hint">Explique por que este item não se aplica.</p>
            <div class="row">
              <div class="field" style="flex:1 1 100%">
                <input type="text" id="na-${itemId}" placeholder="Digite a justificativa..." value="${escapeHtml(st.naJustificativa)}"/>
              </div>
            </div>
          </div>
        `;
        panel.querySelector(`#na-${CSS.escape(itemId)}`).addEventListener("input", (e)=>{
          st.naJustificativa = e.target.value;
        });
        return;
      }

      if(st.status === "C"){
        panel.innerHTML = `
          <div class="panel">
            <h4>Evidência do item (foto obrigatória)</h4>
            <p class="hint">Anexe pelo menos 1 foto do item conforme.</p>
            <div class="row">
              <div class="field" style="flex:1 1 100%">
                <input type="file" id="cf-${itemId}" accept="image/*" />
              </div>
            </div>
            <div class="hint" id="cfcount-${itemId}">${st.conformeFotos.length ? `Fotos anexadas: ${st.conformeFotos.length}` : "Nenhuma foto anexada ainda."}</div>
          </div>
        `;
        panel.querySelector(`#cf-${CSS.escape(itemId)}`).addEventListener("change", (e)=>{
          const files = Array.from(e.target.files || []);
          st.conformeFotos = files;
          updateItemPanel(itemId);
        });
        return;
      }

      // NC
      const desviosHtml = st.desvios.map((d, i) => `
        <div class="deviation">
          <div class="head">
            <span class="badge">Desvio #${i+1}</span>
            <button class="btn danger mini" type="button" data-rm="${i}">Remover</button>
          </div>
          <div class="row">
            <div class="field">
              <label>Foto do desvio (obrigatória)</label>
              <input type="file" accept="image/*" data-foto="${i}" />
              <div class="hint">${d.foto ? `Anexada: ${escapeHtml(d.foto.name)}` : "Nenhuma foto anexada."}</div>
            </div>
            <div class="field">
              <label>Responsável pela tratativa (obrigatório)</label>
              <select data-resp="${i}">
                ${buildResponsaveisOptions(d.responsavel || "Selecione...")}
              </select>
            </div>
          </div>
        </div>
      `).join("");

      panel.innerHTML = `
        <div class="panel">
          <h4>Não Conformidade (NC) — Desvios</h4>
          <p class="hint">Cada foto = 1 desvio. Para cada desvio, selecione um responsável. O mesmo responsável pode aparecer em vários desvios.</p>

          <button class="btn ghost mini" type="button" id="add-${itemId}">+ Adicionar nova NC (novo desvio)</button>

          <div id="desvios-${itemId}">
            ${desviosHtml || `<div class="alert"><strong>Sem desvios ainda.</strong> Clique em “Adicionar nova NC”.</div>`}
          </div>
        </div>
      `;

      panel.querySelector(`#add-${CSS.escape(itemId)}`).addEventListener("click", ()=>{
        st.desvios.push({ foto:null, responsavel:"Selecione..." });
        updateItemPanel(itemId);
      });

      panel.querySelectorAll("[data-rm]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const idx = Number(btn.getAttribute("data-rm"));
          st.desvios.splice(idx, 1);
          updateItemPanel(itemId);
        });
      });

      panel.querySelectorAll("[data-foto]").forEach(inp=>{
        inp.addEventListener("change", (e)=>{
          const i = Number(inp.getAttribute("data-foto"));
          const file = (e.target.files || [])[0] || null;
          st.desvios[i].foto = file;
          updateItemPanel(itemId);
        });
      });

      panel.querySelectorAll("[data-resp]").forEach(sel=>{
        sel.addEventListener("change", ()=>{
          const i = Number(sel.getAttribute("data-resp"));
          st.desvios[i].responsavel = sel.value;
        });
      });
    }

    function validateAll(){
      const errors = [];

      ITENS.forEach(it=>{
        const st = ensureItemState(it.id);
        if(!st.status){
          errors.push(`Item ${it.id}: selecione Conforme/NC/NA.`);
          return;
        }
        if(st.status === "NA"){
          if(!st.naJustificativa.trim()){
            errors.push(`Item ${it.id}: justificativa obrigatória (Não Aplica).`);
          }
        }
        if(st.status === "C"){
          if(!st.conformeFotos || st.conformeFotos.length === 0){
            errors.push(`Item ${it.id}: foto obrigatória (Conforme).`);
          }
        }
        if(st.status === "NC"){
          if(!st.desvios || st.desvios.length === 0){
            errors.push(`Item ${it.id}: adicione ao menos 1 desvio (foto).`);
          } else {
            st.desvios.forEach((d, idx)=>{
              if(!d.foto) errors.push(`Item ${it.id} (Desvio #${idx+1}): foto obrigatória.`);
              if(!d.responsavel || d.responsavel === "Selecione...") errors.push(`Item ${it.id} (Desvio #${idx+1}): responsável obrigatório.`);
            });
          }
        }
      });

      return errors;
    }

    // buildPayload com fieldnames batendo com os arquivos
    function buildPayloadWithFields(){
      const itens = ITENS.map(it=>{
        const st = ensureItemState(it.id);

        return {
          itemId: it.id,
          grupo: it.grupo,
          texto: it.texto,
          status: st.status,
          naJustificativa: st.status==="NA" ? st.naJustificativa : null,

          conformeFotos: st.status==="C"
            ? (st.conformeFotos || []).map((f, idx)=>({
                field: `conf_${it.id}_${idx}`,
                name: f.name,
                size: f.size,
                type: f.type
              }))
            : [],

          desvios: st.status==="NC"
            ? (st.desvios || []).map((d, idx)=>({
                responsavel: d.responsavel,
                foto: d.foto
                  ? {
                      field: `nc_${it.id}_${idx}`,
                      name: d.foto.name,
                      size: d.foto.size,
                      type: d.foto.type
                    }
                  : null
              }))
            : []
        };
      });

      const mat = computeMaturidade();
      const maturidadeFinal = mat.ready ? mat.maturidade : null;

      return {
        semanaId: document.getElementById("semanaId").textContent,
        auditorSemana: document.getElementById("auditorSemana").textContent,
        dataHora: document.getElementById("dataHora").value,
        setor: document.getElementById("setor").value || null,
        maturidade: maturidadeFinal,
        itens
      };
    }

    // Eventos
    document.getElementById("btnExpandir").addEventListener("click", ()=>{
      const items = document.querySelectorAll(".item");
      const anyClosed = Array.from(items).some(i=>!i.classList.contains("open"));
      items.forEach(i=>{
        i.classList.toggle("open", anyClosed);
        i.querySelector(".chev").textContent = anyClosed ? "▲" : "▼";
        i.querySelector(".item-top").setAttribute("aria-expanded", String(anyClosed));
      });
      document.getElementById("btnExpandir").textContent = anyClosed ? "Recolher tudo" : "Expandir tudo";
    });

    // ENVIO
    document.getElementById("btnEnviar").addEventListener("click", async ()=>{
      const btn = document.getElementById("btnEnviar");
      const loading = document.getElementById("loadingEnvio");

      const errs = validateAll();
      if(errs.length){
        alert("Corrija antes de enviar:\n\n- " + errs.join("\n- "));
        return;
      }

      btn.disabled = true;
      loading.classList.add("on");

      try{
        const fd = new FormData();

        // anexar arquivos reais
        ITENS.forEach((it) => {
          const st = ensureItemState(it.id);

          if(st.status === "C"){
            (st.conformeFotos || []).forEach((file, idx)=>{
              fd.append(`conf_${it.id}_${idx}`, file);
            });
          }

          if(st.status === "NC"){
            (st.desvios || []).forEach((d, idx)=>{
              if(d.foto) fd.append(`nc_${it.id}_${idx}`, d.foto);
            });
          }
        });

        const payload = buildPayloadWithFields();
        fd.append("payload", JSON.stringify(payload));

        const res = await fetch("/api/5s/auditorias", {
          method:"POST",
          body: fd
        });

        if(!res.ok){
          const txt = await res.text().catch(()=> "");
          throw new Error(txt || "Falha ao enviar auditoria.");
        }

        const data = await res.json().catch(()=> ({}));
        document.getElementById("auditoriaId").value = data.auditoriaId || "OK";

        // mostrar card de resultado (pós-envio)
        const mat = computeMaturidade();
        const maturidadeFinal = mat.ready ? mat.maturidade : (payload.maturidade ?? 0);
        showResultadoMaturidade(maturidadeFinal);

        alert("Auditoria enviada com sucesso!");
      }catch(err){
        alert("Erro ao enviar: " + (err?.message || err));
      }finally{
        btn.disabled = false;
        loading.classList.remove("on");
      }
    });

    // Init
    document.getElementById("dataHora").value = nowBR();
    initSemanaMock();
    render();
  </script>
</body>
</html>
