<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gest√£o 5S Tecnosonda ‚Äî Painel do Gestor</title>
  <style>
    :root{
      --bg:#f2f4f7;
      --card:#ffffff;
      --text:#101828;
      --muted:#667085;
      --border:#e4e7ec;
      --shadow: 0 10px 24px rgba(16,24,40,.08);
      --primary:#2563eb;
      --danger:#dc2626;
      --ok:#16a34a;
      --warn:#f59e0b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header{
      position: sticky;
      top:0;
      z-index:10;
      background: rgba(242,244,247,.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px 18px}
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex; flex-direction:column; gap:4px}
    .brand h1{margin:0;font-size:18px;letter-spacing:.2px}
    .brand p{margin:0;color:var(--muted);font-size:12px}
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      box-shadow: 0 4px 12px rgba(16,24,40,.04);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    main .wrap{padding-top:18px; padding-bottom:40px}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:16px 16px 10px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .card-h h2{margin:0;font-size:14px}
    .card-h .sub{margin:4px 0 0 0;font-size:12px;color:var(--muted)}
    .card-b{padding:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex: 1 1 220px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field input, .field select{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      outline:none;
      background:#fff;
    }
    .field input:focus, .field select:focus{
      border-color: rgba(37,99,235,.5);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      border:1px solid transparent;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      background: var(--primary);
      color:#fff;
      box-shadow: 0 10px 18px rgba(37,99,235,.18);
      white-space:nowrap;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .btn.ghost{
      background:#fff;
      color:var(--text);
      border-color: var(--border);
      box-shadow:none;
      font-weight:700;
    }
    .btn.danger{
      background: var(--danger);
      box-shadow: 0 10px 18px rgba(220,38,38,.18);
    }
    .btn.warn{
      background: var(--warn);
      box-shadow: 0 10px 18px rgba(245,158,11,.18);
    }
    .mini{padding:8px 10px; border-radius:10px; font-size:12px}

    .kpis{
      display:grid;
      grid-template-columns: repeat(5, minmax(160px, 1fr));
      gap:10px;
    }
    @media (max-width: 980px){
      .kpis{grid-template-columns: repeat(2, minmax(160px, 1fr))}
    }
    .kpi{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .kpi .t{font-size:12px;color:var(--muted);margin:0 0 6px 0}
    .kpi .v{font-size:18px;font-weight:800;margin:0}
    .kpi .s{font-size:12px;color:var(--muted);margin:6px 0 0 0}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--border);
      color: var(--muted);
      background:#fff;
      white-space:nowrap;
    }
    .badge.ok{border-color: rgba(22,163,74,.35); color: var(--ok); background: rgba(22,163,74,.06)}
    .badge.warn{border-color: rgba(245,158,11,.35); color: var(--warn); background: rgba(245,158,11,.08)}
    .badge.danger{border-color: rgba(220,38,38,.35); color: var(--danger); background: rgba(220,38,38,.06)}

    .table-wrap{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:auto;
      background:#fff;
    }
    table{
      border-collapse:collapse;
      width:100%;
      min-width:980px;
      font-size:13px;
    }
    th, td{
      border-bottom:1px solid var(--border);
      padding:10px 12px;
      text-align:left;
      vertical-align:top;
    }
    th{
      position:sticky;
      top:0;
      background:#fbfcfe;
      z-index:2;
      font-size:12px;
      color:var(--muted);
    }
    tr:hover td{background:#fbfdff}
    .link{
      color: var(--primary);
      font-weight:800;
      cursor:pointer;
      text-decoration:none;
    }
    .alert{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:10px 12px;
      font-size:12px;
      color:var(--muted);
    }
    .alert strong{color:var(--text)}
    .loading{
      display:none;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:12px;
    }
    .loading.on{display:inline-flex}
    .dot{
      width:10px;height:10px;border-radius:999px;background:var(--primary);
      animation:pulse .9s infinite ease-in-out;
    }
    @keyframes pulse{
      0%,100%{transform:scale(.9);opacity:.6}
      50%{transform:scale(1.2);opacity:1}
    }

    /* Modal */
    .backdrop{
      position:fixed;
      inset:0;
      background: rgba(16,24,40,.55);
      display:none;
      align-items:flex-start;
      justify-content:center;
      padding:22px;
      z-index:999;
    }
    .backdrop.on{display:flex}
    .modal{
      width:min(980px, 100%);
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: 0 30px 80px rgba(16,24,40,.25);
      overflow:hidden;
    }
    .modal-h{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .modal-h h3{margin:0;font-size:14px}
    .modal-h p{margin:4px 0 0 0;font-size:12px;color:var(--muted)}
    .modal-b{padding:16px; max-height:70vh; overflow:auto}
    .modal-f{
      padding:12px 16px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
      background: rgba(255,255,255,.75);
    }
    .items{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    .item-top{
      padding:12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .item-left{display:flex; gap:10px; align-items:flex-start}
    .num{
      width:28px;height:28px;border-radius:10px;
      display:grid; place-items:center;
      border:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      background: #f8fafc;
      flex:0 0 auto;
    }
    .txt{min-width:0}
    .tag{
      display:inline-flex;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--border);
      color:var(--muted);
      background:#fff;
      margin-bottom:6px;
    }
    .q{margin:0; font-size:13px; line-height:1.35}
    .miniLine{margin:6px 0 0 0; font-size:12px; color:var(--muted)}
    .deviation{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background:#fbfcfe;
    }
    .deviation .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }

    /* ========================= */
    /* ADI√á√ÉO: evid√™ncias clic√°veis */
    /* ========================= */
    .item-click{
      cursor:pointer;
      user-select:none;
    }
    .item-click:hover{
      background:#fbfdff;
    }
    .evi{
      border-top:1px dashed var(--border);
      padding:12px;
      display:none;
      background:#fff;
    }
    .evi.on{display:block}
    .evi-grid{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .thumb{
      width:120px;
      height:86px;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:#f8fafc;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb a{
      display:flex;
      width:100%;
      height:100%;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      color:var(--primary);
      font-weight:800;
      font-size:12px;
      padding:8px;
      text-align:center;
    }
    .muted{
      color:var(--muted);
      font-size:12px;
    }

    /* ADI√á√ÉO: coluna checkbox mais estreita */
    .chkcol{width:46px}
    .chk{
      width:18px;height:18px;
      accent-color: var(--primary);
      cursor:pointer;
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>Gest√£o 5S Tecnosonda</h1>
        <p>Painel do gestor ‚Äî vis√£o geral por semana, detalhes e controle do auditor autom√°tico</p>
      </div>
      <div class="row" style="flex:0 0 auto; justify-content:flex-end">
        <div class="pill">
          Semana atual: <strong id="semanaAtual">‚Äî</strong> ¬∑ Auditor (auto): <strong id="auditorAuto">‚Äî</strong>
        </div>
        <button class="btn ghost mini" id="btnMudarAuditor">Mudar auditor da semana</button>
        <button class="btn mini" id="btnAbrirAvaliacao">Abrir Avalia√ß√£o (avaliacao.html)</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid">

      <!-- KPIs -->
      <section class="card">
        <div class="card-h">
          <div>
            <h2>Indicadores</h2>
            <p class="sub">C√°lculo com base nos registros carregados (por padr√£o, semana selecionada).</p>
          </div>
          <span class="loading" id="loadingKpi"><span class="dot"></span>Carregando...</span>
        </div>
        <div class="card-b">
          <div class="kpis">
            <div class="kpi">
              <p class="t">Total de registros</p>
              <p class="v" id="kpiRegistros">‚Äî</p>
              <p class="s" id="kpiRegistrosSub">‚Äî</p>
            </div>
            <div class="kpi">
              <p class="t">Total de itens</p>
              <p class="v" id="kpiItens">‚Äî</p>
              <p class="s">Somat√≥rio dos itens avaliados</p>
            </div>
            <div class="kpi">
              <p class="t">NCs (desvios)</p>
              <p class="v" id="kpiNC">‚Äî</p>
              <p class="s">Cada foto em NC = 1 desvio</p>
            </div>
            <div class="kpi">
              <p class="t">% Conformidade</p>
              <p class="v" id="kpiPct">‚Äî</p>
              <p class="s">C / (C + NC) ¬∑ 100</p>
            </div>
            <div class="kpi">
              <p class="t">Abertas x Baixadas</p>
              <p class="v" id="kpiAB">‚Äî</p>
              <p class="s">Somente desvios (NC)</p>
            </div>
          </div>
          <div class="alert" style="margin-top:12px">
            <strong>Status de prazo:</strong> para demo, consideramos ‚Äúprazo da tratativa‚Äù at√© o <strong>fim da semana ISO</strong>.
            Se hoje passou do fim da semana, fica <strong>‚ÄúVencido ‚Äî realizar tratativa‚Äù</strong>.
          </div>
        </div>
      </section>

      <!-- Filtros + Tabela -->
      <section class="card">
        <div class="card-h">
          <div>
            <h2>Registros</h2>
            <p class="sub">Clique em ‚ÄúVisualizar‚Äù para abrir a auditoria com todos os detalhes.</p>
          </div>

          <!-- ADI√á√ÉO: bot√µes selecionar/excluir -->
          <div class="row" style="flex:0 0 auto">
            <span class="loading" id="loadingTabela"><span class="dot"></span>Carregando registros...</span>
            <button class="btn ghost mini" id="btnSelecionar">Selecionar</button>
            <button class="btn danger mini" id="btnExcluirSelecionados" disabled>Excluir selecionados</button>
            <button class="btn ghost mini" id="btnRecarregar">Recarregar</button>
          </div>
        </div>

        <div class="card-b">
          <div class="row">
            <div class="field">
              <label>Semana</label>
              <select id="fSemana"></select>
            </div>
            <div class="field">
              <label>Status do prazo</label>
              <select id="fPrazo">
                <option value="Todos">Todos</option>
                <option value="NoPrazo">No prazo</option>
                <option value="Vencido">Vencido</option>
              </select>
            </div>
            <div class="field">
              <label>Auditor</label>
              <input id="fAuditor" placeholder="Filtrar por auditor..." />
            </div>
            <div class="field">
              <label>√Årea/Setor</label>
              <input id="fSetor" placeholder="Ex.: P√°tio / Sonda..." />
            </div>
            <div class="field" style="flex:2 1 320px">
              <label>Busca (ID / texto / respons√°vel)</label>
              <input id="fBusca" placeholder="Ex.: 678... / vazamento / ALLAN..." />
            </div>
          </div>

          <div class="table-wrap" style="margin-top:12px">
            <table>
              <thead>
                <tr>
                  <!-- ADI√á√ÉO: checkbox selecionar tudo -->
                  <th class="chkcol"><input class="chk" type="checkbox" id="chkAll" title="Selecionar tudo" /></th>

                  <th style="width:120px">ID</th>
                  <th style="width:160px">Data/Hora</th>
                  <th style="width:180px">Auditor</th>
                  <th style="width:180px">Setor</th>
                  <th style="width:120px">Dias p/ vencer</th>
                  <th style="width:240px">Status</th>
                  <th style="width:130px">Resumo</th>
                  <th style="width:120px">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="alert">
            <strong>Obs.:</strong> o bot√£o ‚ÄúMudar auditor da semana‚Äù aqui √© uma <strong>sobreposi√ß√£o local</strong> (salva no navegador).
            Depois, se voc√™ quiser, a gente cria uma rota no backend para persistir essa troca no banco.
          </div>
        </div>
      </section>

    </div>
  </div>
</main>

<!-- Modal Visualizar -->
<div class="backdrop" id="backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-h">
      <div>
        <h3 id="modalTitle">Detalhes da auditoria</h3>
        <p id="modalSub">‚Äî</p>
      </div>
      <button class="btn ghost mini" id="btnFecharModal">Fechar</button>
    </div>
    <div class="modal-b" id="modalBody"></div>
    <div class="modal-f">
      <button class="btn ghost mini" id="btnCopiarId">Copiar ID</button>
      <button class="btn mini" id="btnAbrirNoAtlas" disabled title="Apenas informativo (n√£o abre link direto)">(Demo) OK</button>
    </div>
  </div>
</div>

<!-- Modal Mudar Auditor -->
<div class="backdrop" id="backdropAuditor">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-h">
      <div>
        <h3>Mudar auditor da semana</h3>
        <p>Se o auditor autom√°tico n√£o estiver presente, selecione outro para esta semana (salva no navegador).</p>
      </div>
      <button class="btn ghost mini" id="btnFecharAuditor">Fechar</button>
    </div>
    <div class="modal-b">
      <div class="row">
        <div class="field">
          <label>Semana</label>
          <input id="audSemana" readonly />
        </div>
        <div class="field">
          <label>Auditor autom√°tico</label>
          <input id="audAutoInput" readonly />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="field" style="flex:1 1 100%">
          <label>Novo auditor</label>
          <select id="audNovo"></select>
        </div>
      </div>
      <div class="alert">
        <strong>Regras da sua especifica√ß√£o:</strong> auditor √© autom√°tico por semana, mas aqui temos a op√ß√£o de troca via gestor.
      </div>
    </div>
    <div class="modal-f">
      <button class="btn danger mini" id="btnRemoverOverride">Remover troca</button>
      <button class="btn mini" id="btnSalvarOverride">Salvar</button>
    </div>
  </div>
</div>

<script>
  // Lista de nomes (mesma do backend)
  const NOMES_5S = [
    "ALLAN DO NASCIMENTO MORAES",
    "ANDRE DA CONCEICAO ALVES",
    "ANGLA RAKEL SILVA ALMEIDA",
    "ANTONY CHE GUEVARA CAVALCANTE DOS SANTOS",
    "CLEITON DE PAULA BATISTA",
    "DEIVIANE CONCEICAO PEREIRA",
    "EDUARDO DE SOUSA",
    "FERNANDO QUEIROZ DA SILVA",
    "HELIO BARBOSA DOS SANTOS",
    "HERACLITO HENRIQUE SANTANA LOPES",
    "JANAINA KETLEY ANDRADE RIBEIRO",
    "JEOVANE DOS SANTOS SILVA",
    "JORGE MOUZINHO CARVALHO",
    "LUCRECIA SANTOS DO NASCIMENTO",
    "LUIS ANTONIO FELIX DE VASCONCELLOS",
    "MARCELO MONTANDON MARCAL JUNIOR",
    "MARCOS OLIVEIRA MENEZES",
    "RAFAEL HENRIQUE ALVES RIBEIRO",
    "RAPHAEL JOSE PEREIRA DA SILVA",
    "RODRIGO BARBOSA DA SILVA",
    "MARCOS VINICUS BATISTA RIBEIRO",
    "TAINARA BERTUNES DOS SANTOS",
    "VERONICA LUIZA GOMES DE MENEZES",
    "WILDSON DA SILVA BARROS"
  ];

  const $ = (id) => document.getElementById(id);

  let semanaAtual = null;
  let auditorAuto = null;
  let registros = [];     // lista carregada (semana selecionada) (mantido)
  let registrosAll = [];  // cache geral (todas as semanas, se buscarmos)
  let selectedDocId = null;

  // ADI√á√ÉO: modo sele√ß√£o
  let selectionMode = false;

  // ====== Datas / Semana ISO ======
  function parseSemanaId(semanaId){
    // Ex.: "2026-W05"
    const [y, w] = semanaId.split("-W");
    return { year: Number(y), week: Number(w) };
  }
  function startOfISOWeek(year, week){
    // Segunda-feira 00:00
    const simple = new Date(Date.UTC(year, 0, 4));
    const dow = simple.getUTCDay() || 7; // 1..7
    const week1Monday = new Date(simple);
    week1Monday.setUTCDate(simple.getUTCDate() - (dow - 1));
    const monday = new Date(week1Monday);
    monday.setUTCDate(week1Monday.getUTCDate() + (week - 1) * 7);
    return monday;
  }
  function endOfISOWeek(year, week){
    const monday = startOfISOWeek(year, week);
    const end = new Date(monday);
    end.setUTCDate(monday.getUTCDate() + 6);
    end.setUTCHours(23,59,59,999);
    return end;
  }
  function daysToEndOfWeek(semanaId){
    const { year, week } = parseSemanaId(semanaId);
    const end = endOfISOWeek(year, week);
    const now = new Date();
    const ms = end.getTime() - now.getTime();
    return Math.ceil(ms / 86400000);
  }
  function prazoBadge(semanaId){
    const d = daysToEndOfWeek(semanaId);
    if (d < 0) return { label: "Vencido ‚Äî realizar tratativa", cls: "danger", dias: d };
    if (d === 0) return { label: "Vence hoje", cls: "warn", dias: d };
    return { label: "No prazo", cls: "ok", dias: d };
  }

  // ====== Auditor override local ======
  function lsKey(semanaId){
    return `5s_auditor_override_${semanaId}`;
  }
  function getAuditorSemana(semanaId, auditorAuto){
    const o = localStorage.getItem(lsKey(semanaId));
    return o || auditorAuto || "‚Äî";
  }

  function fillSelectNomes(selectEl, selected){
    selectEl.innerHTML = NOMES_5S
      .map(n => `<option value="${escapeHtml(n)}" ${n===selected?'selected':''}>${escapeHtml(n)}</option>`)
      .join("");
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // =========================
  // ADI√á√ÉO: resolver URL de foto (suporta string ou objeto)
  // =========================
  function resolveFotoUrl(f){
    if(!f) return "";
    if(typeof f === "string") return f;
    return (
      f.url ||
      f.secure_url ||
      f.link ||
      f.href ||
      f.path ||
      f.location ||
      ""
    );
  }
  function resolveFotoName(f){
    if(!f) return "‚Äî";
    if(typeof f === "string"){
      try{
        const u = new URL(f);
        return u.pathname.split("/").pop() || f;
      }catch{
        return f;
      }
    }
    return f.name || f.originalname || f.filename || "‚Äî";
  }

  function renderThumbs(list){
    const arr = Array.isArray(list) ? list : [];
    if(!arr.length) return `<div class="muted">Sem evid√™ncia cadastrada.</div>`;
    const thumbs = arr.map((f) => {
      const url = resolveFotoUrl(f);
      const name = resolveFotoName(f);
      if(url){
        return `
          <div class="thumb">
            <a href="${escapeHtml(url)}" target="_blank" rel="noopener">
              <img src="${escapeHtml(url)}" alt="${escapeHtml(name)}" />
            </a>
          </div>
        `;
      }
      return `
        <div class="thumb">
          <a href="javascript:void(0)">${escapeHtml(name)}</a>
        </div>
      `;
    }).join("");
    return `<div class="evi-grid">${thumbs}</div>`;
  }

  // ====== KPIs ======
  function calcKPIs(list){
    let totalItens = 0;
    let c = 0, nc = 0, na = 0;
    let desviosTotal = 0;
    let desviosBaixados = 0;
    let desviosAbertos = 0;

    for(const doc of list){
      const itens = Array.isArray(doc.itens) ? doc.itens : [];
      totalItens += itens.length;

      for(const it of itens){
        if(it.status === "C") c++;
        else if(it.status === "NC") nc++;
        else if(it.status === "NA") na++;

        if(it.status === "NC"){
          const desvios = Array.isArray(it.desvios) ? it.desvios : [];
          for(const d of desvios){
            desviosTotal++;
            const baixado = !!(d?.baixa?.dataHora || (Array.isArray(d?.baixa?.fotosResolucao) && d.baixa.fotosResolucao.length));
            if(baixado) desviosBaixados++;
            else desviosAbertos++;
          }
        }
      }
    }

    const denom = (c + nc);
    const pct = denom > 0 ? (c / denom) * 100 : 0;
    return {
      registros: list.length,
      totalItens,
      desviosTotal,
      pctConformidade: pct,
      baixadas: desviosBaixados,
      abertas: desviosAbertos,
      breakdown: { c, nc, na }
    };
  }

  function setKPIs(list, semanaId){
    const k = calcKPIs(list);
    $("kpiRegistros").textContent = String(k.registros);
    $("kpiRegistrosSub").textContent = semanaId ? `Semana: ${semanaId}` : "‚Äî";
    $("kpiItens").textContent = String(k.totalItens);
    $("kpiNC").textContent = String(k.desviosTotal);
    $("kpiPct").textContent = `${k.pctConformidade.toFixed(1)}%`;
    $("kpiAB").textContent = `${k.abertas} / ${k.baixadas}`;
  }

  // ====== Render tabela ======
  function countResumo(doc){
    const itens = Array.isArray(doc.itens) ? doc.itens : [];
    let C=0, NC=0, NA=0, desv=0;
    for(const it of itens){
      if(it.status==="C") C++;
      if(it.status==="NC"){
        NC++;
        desv += Array.isArray(it.desvios) ? it.desvios.length : 0;
      }
      if(it.status==="NA") NA++;
    }
    return { C, NC, NA, desv };
  }

  function matchesFilter(doc){
    const semanaSel = $("fSemana").value;
    const prazoSel = $("fPrazo").value;
    const auditorTxt = ($("fAuditor").value || "").trim().toLowerCase();
    const setorTxt = ($("fSetor").value || "").trim().toLowerCase();
    const buscaTxt = ($("fBusca").value || "").trim().toLowerCase();

    if(semanaSel && semanaSel !== "Todas" && doc.semanaId !== semanaSel) return false;

    const pr = prazoBadge(doc.semanaId || semanaAtual || "");
    if(prazoSel === "Vencido" && pr.dias >= 0) return false;
    if(prazoSel === "NoPrazo" && pr.dias < 0) return false;

    const auditor = (getAuditorSemana(doc.semanaId, doc.auditorSemana) || "").toLowerCase();
    if(auditorTxt && !auditor.includes(auditorTxt)) return false;

    const setor = (doc.setor || "").toLowerCase();
    if(setorTxt && !setor.includes(setorTxt)) return false;

    if(buscaTxt){
      const id = String(doc._id || "").toLowerCase();
      const data = String(doc.dataHora || "").toLowerCase();

      let found = false;
      const itens = Array.isArray(doc.itens) ? doc.itens : [];
      for(const it of itens){
        const t = (it.texto || "").toLowerCase();
        const g = (it.grupo || "").toLowerCase();
        if(t.includes(buscaTxt) || g.includes(buscaTxt)) { found = true; break; }

        if(it.status === "NC"){
          const desv = Array.isArray(it.desvios) ? it.desvios : [];
          for(const d of desv){
            const r = (d.responsavel || "").toLowerCase();
            if(r.includes(buscaTxt)) { found = true; break; }
          }
          if(found) break;
        }
      }

      if(!(id.includes(buscaTxt) || data.includes(buscaTxt) || setor.includes(buscaTxt) || auditor.includes(buscaTxt) || found)){
        return false;
      }
    }

    return true;
  }

  // ADI√á√ÉO: util sele√ß√£o
  function getSelectedIds(){
    const ids = [];
    document.querySelectorAll('input[data-sel-id]:checked').forEach(chk => ids.push(chk.getAttribute("data-sel-id")));
    return ids;
  }
  function refreshDeleteButton(){
    const count = getSelectedIds().length;
    $("btnExcluirSelecionados").disabled = !(selectionMode && count > 0);
    $("btnExcluirSelecionados").textContent = count > 0 ? `Excluir selecionados (${count})` : "Excluir selecionados";
  }

  function renderTable(){
    const tbody = $("tbody");
    tbody.innerHTML = "";

    const list = registrosAll.filter(matchesFilter);

    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="9" style="color:var(--muted)">Nenhum registro encontrado com os filtros atuais.</td></tr>`;
      setKPIs(list, $("fSemana").value === "Todas" ? null : $("fSemana").value);
      refreshDeleteButton();
      return;
    }

    setKPIs(list, $("fSemana").value === "Todas" ? null : $("fSemana").value);

    for(const doc of list){
      const pr = prazoBadge(doc.semanaId);
      const auditor = getAuditorSemana(doc.semanaId, doc.auditorSemana);
      const r = countResumo(doc);
      const badgeCls = pr.cls === "ok" ? "ok" : pr.cls === "warn" ? "warn" : "danger";
      const diasTxt = String(pr.dias);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <!-- ADI√á√ÉO: checkbox -->
        <td class="chkcol">
          <input class="chk" type="checkbox" data-sel-id="${escapeHtml(doc._id)}" ${selectionMode ? "" : "disabled"} />
        </td>

        <td><span class="link" data-open="${escapeHtml(doc._id)}">${escapeHtml(String(doc._id).slice(0,8))}...</span></td>
        <td>${escapeHtml(doc.dataHora || "‚Äî")}</td>
        <td>${escapeHtml(auditor || "‚Äî")}</td>
        <td>${escapeHtml(doc.setor || "‚Äî")}</td>
        <td><strong>${diasTxt}</strong></td>
        <td><span class="badge ${badgeCls}">${escapeHtml(pr.label)}</span></td>
        <td>
          <span class="badge">${r.C} C</span>
          <span class="badge">${r.NC} NC</span>
          <span class="badge">${r.NA} NA</span>
          <span class="badge">${r.desv} desvios</span>
        </td>
        <td><button class="btn ghost mini" data-open="${escapeHtml(doc._id)}">Visualizar</button></td>
      `;
      tbody.appendChild(tr);
    }

    tbody.querySelectorAll("[data-open]").forEach(el=>{
      el.addEventListener("click", ()=> openDetails(el.getAttribute("data-open")));
    });

    // ADI√á√ÉO: escuta sele√ß√£o
    tbody.querySelectorAll('input[data-sel-id]').forEach(chk=>{
      chk.addEventListener("change", refreshDeleteButton);
    });

    // Atualiza chkAll conforme lista
    const enabled = selectionMode && list.length > 0;
    $("chkAll").disabled = !enabled;
    if(!enabled) $("chkAll").checked = false;

    refreshDeleteButton();
  }

  // ====== Modal detalhes ======
  function openBackdrop(on=true){
    $("backdrop").classList.toggle("on", on);
  }
  function closeDetails(){
    selectedDocId = null;
    openBackdrop(false);
    $("modalBody").innerHTML = "";
    $("modalSub").textContent = "‚Äî";
  }

  async function openDetails(id){
    selectedDocId = id;
    openBackdrop(true);
    $("modalBody").innerHTML = `<span class="loading on"><span class="dot"></span>Carregando detalhes...</span>`;

    try{
      const res = await fetch(`/api/5s/auditorias/${encodeURIComponent(id)}`);
      if(!res.ok) throw new Error("Falha ao buscar detalhes.");
      const doc = await res.json();

      const pr = prazoBadge(doc.semanaId);
      const auditor = getAuditorSemana(doc.semanaId, doc.auditorSemana);

      $("modalTitle").textContent = `Auditoria 5S ‚Äî ${String(doc._id).slice(0,8)}...`;
      $("modalSub").innerHTML = `
        Semana: <strong>${escapeHtml(doc.semanaId || "‚Äî")}</strong> ¬∑
        Auditor: <strong>${escapeHtml(auditor || "‚Äî")}</strong> ¬∑
        Data/Hora: <strong>${escapeHtml(doc.dataHora || "‚Äî")}</strong> ¬∑
        Setor: <strong>${escapeHtml(doc.setor || "‚Äî")}</strong> ¬∑
        <span class="badge ${pr.cls==="ok"?"ok":pr.cls==="warn"?"warn":"danger"}">${escapeHtml(pr.label)} (dias: ${pr.dias})</span>
      `;

      $("btnCopiarId").onclick = async () => {
        try{
          await navigator.clipboard.writeText(String(doc._id));
          alert("ID copiado!");
        }catch{
          alert("N√£o foi poss√≠vel copiar (bloqueio do navegador).");
        }
      };

      const itens = Array.isArray(doc.itens) ? doc.itens : [];

      let html = `
        <div class="alert">
          <strong>Informa√ß√µes do registro:</strong><br/>
          ID: <strong>${escapeHtml(String(doc._id))}</strong><br/>
          Semana: <strong>${escapeHtml(doc.semanaId || "‚Äî")}</strong><br/>
          Auditor: <strong>${escapeHtml(auditor || "‚Äî")}</strong><br/>
          Data/Hora: <strong>${escapeHtml(doc.dataHora || "‚Äî")}</strong><br/>
          √Årea/Setor: <strong>${escapeHtml(doc.setor || "‚Äî")}</strong>
        </div>

        <div class="alert" style="margin-top:12px">
          <strong>Dica:</strong> clique em um item para abrir/fechar as <strong>evid√™ncias</strong> (Conforme e N√£o Conforme).
        </div>

        <div class="items" style="margin-top:12px">
      `;

      itens.forEach((it, idx) => {
        const st = it.status || "‚Äî";
        const stBadge =
          st === "C"  ? `<span class="badge ok">Conforme</span>` :
          st === "NC" ? `<span class="badge danger">N√£o Conforme</span>` :
          st === "NA" ? `<span class="badge warn">N√£o Aplica</span>` :
                        `<span class="badge">‚Äî</span>`;

        const conformeFotos = Array.isArray(it.conformeFotos) ? it.conformeFotos : [];
        const desvios = Array.isArray(it.desvios) ? it.desvios : [];

        let extra = "";
        if(st === "NA"){
          extra = `<p class="miniLine"><strong>Justificativa:</strong> ${escapeHtml(it.naJustificativa || "‚Äî")}</p>`;
        }
        if(st === "C"){
          extra = `<p class="miniLine"><strong>Evid√™ncia:</strong> ${conformeFotos.length ? `${conformeFotos.length} foto(s)` : "‚Äî"}</p>`;
        }

        // ADI√á√ÉO: montar evid√™ncias detalhadas por status
        let evidenciasHtml = "";

        if(st === "C"){
          evidenciasHtml = `
            <div class="evi" id="evi-${idx}">
              <div class="badge ok">Evid√™ncias (Conforme)</div>
              ${renderThumbs(conformeFotos)}
            </div>
          `;
        }

        if(st === "NC"){
          // fotos do NC: d.foto
          // fotos da baixa (resolu√ß√£o): d.baixa.fotosResolucao
          let dhtml = "";
          if(!desvios.length){
            dhtml = `<div class="muted">Sem desvios cadastrados.</div>`;
          }else{
            dhtml = desvios.map((d, i) => {
              const baixado = !!(d?.baixa?.dataHora || (Array.isArray(d?.baixa?.fotosResolucao) && d.baixa.fotosResolucao.length));
              const b = baixado
                ? `<span class="badge ok">Baixado</span>`
                : (pr.dias < 0 ? `<span class="badge danger">Vencido</span>` : `<span class="badge warn">Aberto</span>`);

              const fotosNC = d?.foto ? [d.foto] : [];
              const fotosResolucao = Array.isArray(d?.baixa?.fotosResolucao) ? d.baixa.fotosResolucao : [];

              return `
                <div class="deviation">
                  <div class="head">
                    <span class="badge">Desvio #${i+1}</span>
                    ${b}
                  </div>

                  <p class="miniLine"><strong>Respons√°vel:</strong> ${escapeHtml(d.responsavel || "‚Äî")}</p>

                  <div style="margin-top:10px">
                    <div class="badge danger">Evid√™ncia (N√£o Conforme)</div>
                    ${renderThumbs(fotosNC)}
                  </div>

                  ${baixado ? `
                    <p class="miniLine" style="margin-top:10px"><strong>Baixa em:</strong> ${escapeHtml(d?.baixa?.dataHora || "‚Äî")}</p>
                    <div style="margin-top:10px">
                      <div class="badge ok">Evid√™ncia (Resolu√ß√£o / Baixa)</div>
                      ${renderThumbs(fotosResolucao)}
                    </div>
                  ` : `
                    <div class="muted" style="margin-top:10px">Ainda sem baixa/anexo de resolu√ß√£o.</div>
                  `}
                </div>
              `;
            }).join("");
          }

          extra = `<p class="miniLine"><strong>Desvios:</strong> ${desvios.length}</p>`;

          evidenciasHtml = `
            <div class="evi" id="evi-${idx}">
              <div class="badge danger">Evid√™ncias (N√£o Conforme)</div>
              <div style="margin-top:10px">${dhtml}</div>
            </div>
          `;
        }

        // Item ‚Äúclic√°vel‚Äù
        html += `
          <div class="item">
            <div class="item-top item-click" data-toggle-evi="${idx}" title="Clique para ver evid√™ncias">
              <div class="item-left">
                <div class="num">${idx+1}</div>
                <div class="txt">
                  <div class="tag">${escapeHtml(it.grupo || "‚Äî")}</div>
                  <p class="q">${escapeHtml(it.texto || "‚Äî")}</p>
                  ${extra}
                </div>
              </div>
              <div>${stBadge}</div>
            </div>
            ${evidenciasHtml}
          </div>
        `;
      });

      html += `</div>`;
      $("modalBody").innerHTML = html;

      // ADI√á√ÉO: clique para abrir/fechar evid√™ncias
      $("modalBody").querySelectorAll("[data-toggle-evi]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const idx = el.getAttribute("data-toggle-evi");
          const box = document.getElementById(`evi-${idx}`);
          if(box) box.classList.toggle("on");
        });
      });

    }catch(err){
      $("modalBody").innerHTML = `<div class="alert"><strong>Erro:</strong> ${escapeHtml(err?.message || err)}</div>`;
    }
  }

  // ====== Carregamento ======
  async function loadSemanaAtual(){
    try{
      const res = await fetch("/api/5s/semana-atual");
      if(!res.ok) throw new Error("Falha ao buscar semana atual.");
      const data = await res.json();

      semanaAtual = data.semanaId || null;
      auditorAuto = data.auditorSemana || null;

      $("semanaAtual").textContent = semanaAtual || "‚Äî";
      $("auditorAuto").textContent = getAuditorSemana(semanaAtual, auditorAuto);

      // prepara modal mudar auditor
      $("audSemana").value = semanaAtual || "";
      $("audAutoInput").value = auditorAuto || "";
      fillSelectNomes($("audNovo"), getAuditorSemana(semanaAtual, auditorAuto));
    }catch{
      $("semanaAtual").textContent = "erro";
      $("auditorAuto").textContent = "erro";

      // üîß GARANTE valor inicial do filtro de semana
if ($("fSemana")) {
  $("fSemana").innerHTML = `
    <option value="Todas">Todas</option>
    <option value="${semanaAtual}">${semanaAtual}</option>
  `;
  $("fSemana").value = "Todas";
}

    }
  }

  function fill
<script>
  // ... (seu c√≥digo acima fica igual)

  function fillSemanasSelect(semanas){
    const sel = $("fSemana");
    const opts = [`<option value="Todas">Todas</option>`]
      .concat(semanas.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`));
    sel.innerHTML = opts.join("");
    // se tiver semanaAtual, seleciona ela
    if(semanaAtual && semanas.includes(semanaAtual)){
      sel.value = semanaAtual;
    } else {
      sel.value = "Todas";
    }
  }

  async function loadSemanas(){
    // tenta rota dedicada; se n√£o existir, cai no fallback.
    try{
      const res = await fetch("/api/5s/semanas");
      if(res.ok){
        const data = await res.json();
        const semanas = Array.isArray(data) ? data : (Array.isArray(data.semanas) ? data.semanas : []);
        if(semanas.length){
          fillSemanasSelect(semanas);
          return semanas;
        }
      }
    }catch{}

    // fallback: busca geral e extrai semanas
    try{
      const res2 = await fetch("/api/5s/auditorias?all=1");
      if(res2.ok){
        const docs = await res2.json();
        const semanas = [...new Set((Array.isArray(docs)?docs:[]).map(d=>d.semanaId).filter(Boolean))].sort().reverse();
        fillSemanasSelect(semanas);
        return semanas;
      }
    }catch{}

    // se nada funcionar, pelo menos mostra a semana atual
    fillSemanasSelect(semanaAtual ? [semanaAtual] : []);
    return semanaAtual ? [semanaAtual] : [];
  }

  async function loadAuditorias(){
    $("loadingTabela").classList.add("on");
    $("loadingKpi").classList.add("on");

    try{
      // carrega tudo para permitir filtro "Todas"
      const res = await fetch("/api/5s/auditorias?all=1");
      if(!res.ok) throw new Error("Falha ao carregar auditorias.");
      const docs = await res.json();

      registrosAll = Array.isArray(docs) ? docs : [];
      registros = registrosAll; // mantido por compatibilidade

      renderTable();
    }catch(err){
      $("tbody").innerHTML = `<tr><td colspan="9" style="color:var(--muted)">Erro ao carregar: ${escapeHtml(err?.message || err)}</td></tr>`;
      setKPIs([], null);
    }finally{
      $("loadingTabela").classList.remove("on");
      $("loadingKpi").classList.remove("on");
    }
  }

  // ====== Exclus√£o ======
  async function excluirSelecionados(){
    const ids = getSelectedIds();
    if(!ids.length) return;

    const ok = confirm(`Tem certeza que deseja excluir ${ids.length} registro(s)? Essa a√ß√£o n√£o pode ser desfeita.`);
    if(!ok) return;

    $("btnExcluirSelecionados").disabled = true;

    try{
      // tenta exclus√£o em lote; se n√£o existir, exclui um por um
      let res = await fetch("/api/5s/auditorias/excluir", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ ids })
      });

      if(!res.ok){
        // fallback: delete individual
        for(const id of ids){
          const r = await fetch(`/api/5s/auditorias/${encodeURIComponent(id)}`, { method:"DELETE" });
          if(!r.ok) throw new Error(`Falha ao excluir ID ${id}.`);
        }
      }

      // remove do cache local
      registrosAll = registrosAll.filter(d => !ids.includes(String(d._id)));
      renderTable();
      alert("Exclus√£o conclu√≠da.");
    }catch(err){
      alert(`Erro ao excluir: ${err?.message || err}`);
      refreshDeleteButton();
    }
  }

  // ====== Eventos UI ======
  function bindEvents(){
    // filtros
    ["fSemana","fPrazo","fAuditor","fSetor","fBusca"].forEach(id=>{
      $(id).addEventListener("input", renderTable);
      $(id).addEventListener("change", renderTable);
    });

    $("btnRecarregar").addEventListener("click", async ()=>{
      await loadAuditorias();
    });

    // sele√ß√£o
    $("btnSelecionar").addEventListener("click", ()=>{
      selectionMode = !selectionMode;
      $("btnSelecionar").textContent = selectionMode ? "Cancelar sele√ß√£o" : "Selecionar";
      // habilita/desabilita checkboxes na tabela (re-render)
      renderTable();
    });

    $("btnExcluirSelecionados").addEventListener("click", excluirSelecionados);

    $("chkAll").addEventListener("change", ()=>{
      const checked = $("chkAll").checked;
      document.querySelectorAll('input[data-sel-id]').forEach(chk=>{
        if(!chk.disabled) chk.checked = checked;
      });
      refreshDeleteButton();
    });

    // modal detalhes
    $("btnFecharModal").addEventListener("click", closeDetails);
    $("backdrop").addEventListener("click", (e)=>{
      if(e.target === $("backdrop")) closeDetails();
    });
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        if($("backdrop").classList.contains("on")) closeDetails();
        if($("backdropAuditor").classList.contains("on")) closeAuditorModal();
      }
    });

    // abrir avalia√ß√£o
    $("btnAbrirAvaliacao").addEventListener("click", ()=>{
      window.location.href = "avaliacao.html";
    });

    // modal auditor
    $("btnMudarAuditor").addEventListener("click", openAuditorModal);
    $("btnFecharAuditor").addEventListener("click", closeAuditorModal);
    $("backdropAuditor").addEventListener("click", (e)=>{
      if(e.target === $("backdropAuditor")) closeAuditorModal();
    });

    $("btnSalvarOverride").addEventListener("click", ()=>{
      if(!semanaAtual) return;
      const novo = $("audNovo").value;
      localStorage.setItem(lsKey(semanaAtual), novo);
      $("auditorAuto").textContent = getAuditorSemana(semanaAtual, auditorAuto);
      closeAuditorModal();
      renderTable();
    });

    $("btnRemoverOverride").addEventListener("click", ()=>{
      if(!semanaAtual) return;
      localStorage.removeItem(lsKey(semanaAtual));
      $("auditorAuto").textContent = getAuditorSemana(semanaAtual, auditorAuto);
      fillSelectNomes($("audNovo"), getAuditorSemana(semanaAtual, auditorAuto));
      closeAuditorModal();
      renderTable();
    });
  }

  function openAuditorModal(){
    $("audSemana").value = semanaAtual || "";
    $("audAutoInput").value = auditorAuto || "";
    fillSelectNomes($("audNovo"), getAuditorSemana(semanaAtual, auditorAuto));
    $("backdropAuditor").classList.add("on");
  }
  function closeAuditorModal(){
    $("backdropAuditor").classList.remove("on");
  }

  // ====== Init ======
  (async function init(){
    bindEvents();
    await loadSemanaAtual();
    await loadSemanas();
    await loadAuditorias();
  })();
</script>
</body>
</html>
