<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notificação de Risco</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    :root{
      --bg1:#0e1a1a; --bg2:#0b2a24; --bg3:#0a1e2d;
      --primary:#00bfa6; --primary-600:#00a892; --accent:#ffd166;
      --muted:#b9d9d4; --text:#e5f7f4;
      --glass: rgba(255,255,255,.06); --borderC: rgba(255,255,255,.14);
      --radius:18px; --shadow:0 8px 30px rgba(0,0,0,.35);
      --ring: 0 10px 30px rgba(0,191,166,.25); --transition:.35s cubic-bezier(.2,.8,.2,1);
      --input-bg: rgba(12,20,28,.55); --input-bd: rgba(255,255,255,.14); --input-ph:#9fc9c3;
      --danger:#ff6b6b; --success:#1dd1a1;
    }

    /* ===== Loading Overlay ===== */
    .loading {
      position: fixed;
      inset: 0;
      display: none;      /* .show => vira grid */
      place-items: center;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(4px);
      z-index: 99;
    }
    .loading.show { display: grid; }
    .loading-card{
      display: inline-flex;
      align-items: center;
      gap: .8rem;
      padding: .9rem 1.1rem;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 8px 30px rgba(0,0,0,.35);
      color: #eafffb; font-weight: 800;
    }
    .loading-card i { font-size: 1.2rem; }
    .btn[aria-busy="true"]{ pointer-events:none; opacity:.85; transform:translateY(0)!important; }

    /* Reset */
    *,*:before,*:after{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% -10%, #0f3d3a55, transparent 60%),
        radial-gradient(1000px 800px at 110% 10%, #0a2f4850, transparent 60%),
        linear-gradient(120deg, var(--bg1), var(--bg2) 55%, var(--bg3));
      overflow-x:hidden;
    }

    /* Ambient glow */
    .ambient{
      position: fixed; inset: -20vmax; pointer-events:none; z-index:0;
      background:
        radial-gradient(35vmax 35vmax at 20% 20%, rgba(0,191,166,.12), transparent 60%),
        radial-gradient(40vmax 40vmax at 80% 10%, rgba(64,188,255,.10), transparent 65%),
        radial-gradient(30vmax 30vmax at 50% 90%, rgba(255,209,102,.10), transparent 70%);
      filter: blur(30px) saturate(120%);
      animation: float 18s ease-in-out infinite alternate;
    }
    @keyframes float{ 0%{ transform: translate3d(0,0,0) scale(1);} 100%{ transform: translate3d(2%,-1%,0) scale(1.03);} }

    /* Header */
    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(8,15,23,.7), rgba(8,15,23,.35) 60%, transparent);
      border-bottom: 1px solid var(--borderC);
    }
    .header-wrap{
      max-width:1100px; margin:0 auto;
      padding: 1rem clamp(1rem,3vw,1.5rem);
      display:flex; align-items:center; justify-content:space-between; gap:1rem;
    }
    .brand{ display:flex; align-items:center; gap:.8rem; color:var(--text); text-decoration:none; }
    .logo{
      width:42px; height:42px; border-radius:14px; position:relative; overflow:hidden;
      background: conic-gradient(from 200deg at 50% 50%, #00bfa6, #40bcff, #ffd166, #00bfa6);
      box-shadow: inset 0 0 0 3px rgba(0,0,0,.35), 0 10px 25px rgba(0,0,0,.3);
      display:grid; place-items:center;
    }
    .logo::after{ content:""; position:absolute; inset:2px; border-radius:12px;
      background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55)); }
    .logo i{ position:relative; z-index:1; color:#eafffb; }
    .title{ font-weight:800; letter-spacing:.2px; line-height:1.1; }
    .subtitle{ font-size:.9rem; color:var(--muted); }

    /* Container */
    .container{
      position:relative; z-index:1;
      max-width:900px;
      margin: clamp(1rem,3vw,2rem) auto;
      padding: 0 clamp(1rem,3vw,1.5rem) 2rem;
    }

    /* Back button */
    .back-container{ margin-bottom:1rem; }
    .btn-back{
      display:inline-flex; align-items:center; gap:.6rem;
      padding:.7rem 1rem; border-radius:12px;
      text-decoration:none; color:#041311; font-weight:700;
      background: linear-gradient(135deg, var(--primary), #40bcff);
      box-shadow: inset 0 -2px 0 rgba(0,0,0,.2), 0 8px 16px rgba(0,191,166,.25);
      transition: transform var(--transition), box-shadow var(--transition), filter var(--transition);
    }
    .btn-back:hover{ transform:translateY(-2px); box-shadow: 0 14px 28px rgba(0,191,166,.35); filter:saturate(110%); }

    /* Form card */
    .form-card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--borderC);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: clamp(1rem, 3vw, 1.5rem);
    }

    h1{
      margin:0 0 .75rem 0;
      font-size: clamp(1.25rem, 1rem + 1.2vw, 1.8rem);
      font-weight:800; letter-spacing:.2px;
    }
    .form-sub{ margin:0 0 1rem 0; color:var(--muted); }

    /* Grid fields */
    .grid{ display:grid; gap:1rem; }
    @media(min-width:720px){
      .grid-2{ grid-template-columns: 1fr 1fr; }
      .grid-3{ grid-template-columns: 1fr 1fr 1fr; }
    }

    /* Field */
    .field{ display:flex; flex-direction:column; gap:.45rem; }
    label{ font-weight:700; font-size:.95rem; letter-spacing:.15px; }
    .input{
      display:flex; align-items:center; gap:.6rem;
      background: var(--input-bg);
      border:1px solid var(--input-bd);
      border-radius:14px;
      padding:.8rem .9rem;
      transition: border-color var(--transition), box-shadow var(--transition), transform var(--transition);
    }
    .input i{ color:var(--muted); font-size:1rem; }
    .input:focus-within{
      border-color: rgba(0,191,166,.6);
      box-shadow: var(--ring);
      transform: translateY(-1px);
    }

    /* Opções do select no dropdown */
    select option,
    .input select option{
      color:#000; background:#fff;
    }

    .input input[type="text"],
    .input input[type="date"],
    .input select,
    .input textarea{
      width:100%; background:transparent; border:none; outline:none; color:var(--text);
      font-size:1rem;
    }
    .input textarea{ resize: vertical; min-height: 84px; }
    .input ::placeholder{ color: var(--input-ph); }

    /* File drop */
    .dropzone{
      position:relative; border:1px dashed rgba(255,255,255,.25);
      background: linear-gradient(180deg, rgba(0,191,166,.06), rgba(64,188,255,.05));
      border-radius:14px; padding:1rem;
      display:flex; align-items:center; gap:.8rem; flex-wrap:wrap;
      transition: border-color var(--transition), background var(--transition);
    }
    .dropzone.dragover{
      border-color: rgba(0,191,166,.8);
      background: linear-gradient(180deg, rgba(0,191,166,.12), rgba(64,188,255,.10));
      box-shadow: var(--ring);
    }
    .dropzone input[type="file"]{ position:absolute; inset:0; opacity:0; cursor:pointer; }
    .file-label{ display:flex; align-items:center; gap:.6rem; font-weight:700; }
    .file-info{ font-size:.9rem; color:var(--muted); }

    /* Actions */
    .actions{ margin-top:1rem; display:flex; gap:.8rem; flex-wrap:wrap; }
    .btn{
      appearance:none; border:none; cursor:pointer;
      text-decoration:none; color:#041311; font-weight:800;
      background: linear-gradient(135deg, var(--primary), #40bcff);
      padding: .9rem 1.1rem; border-radius:14px;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,.2), 0 8px 16px rgba(0,191,166,.25);
      transition: transform var(--transition), box-shadow var(--transition), filter var(--transition);
      display:inline-flex; align-items:center; gap:.6rem; font-size:1rem;
      width:100%;
    }
    .btn:hover{ transform: translateY(-2px); box-shadow: 0 14px 28px rgba(0,191,166,.35); filter:saturate(110%); }
    @media(min-width:520px){ .btn{ width:auto; } }

    /* Success alert (toast) */
    .alert{
      position: fixed; right: 1rem; bottom: 1rem; z-index: 10;
      display:flex; align-items:center; gap:.8rem; flex-wrap:wrap;
      padding:.85rem 1rem; border-radius:14px;
      background: linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.55));
      border:1px solid rgba(255,255,255,.18);
      color:#eafffb; box-shadow: var(--shadow);
      transform: translateY(120%); opacity:0; pointer-events:none;
      transition: transform var(--transition), opacity var(--transition);
    }
    .alert.show{ transform: translateY(0); opacity:1; pointer-events:auto; }
    .alert .badge{
      display:inline-flex; align-items:center; gap:.45rem; font-weight:800; padding:.35rem .6rem; border-radius:999px;
      background: linear-gradient(135deg, #0bb37b, #1dd1a1); color:#01251f; border:1px solid rgba(255,255,255,.2);
    }
    .alert a{
      text-decoration:none; font-weight:800; color:#041311; white-space:nowrap;
      background: linear-gradient(135deg, var(--accent), #ffe29f);
      padding:.55rem .75rem; border-radius:10px;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,.2);
      transition: transform var(--transition), filter var(--transition);
    }
    .alert a:hover{ transform: translateY(-1px); filter:saturate(110%); }

    .divider{ height:1px; background:linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent); margin:.4rem 0 1rem; }
    :focus-visible{ outline:2px solid #40bcff; outline-offset:2px; border-radius:12px; }
    @media (prefers-reduced-motion: reduce){ .ambient, .btn, .input, .alert{ transition:none; animation:none; } }
  </style>
</head>
<body>
  <div class="ambient" aria-hidden="true"></div>

  <header>
    <div class="header-wrap">
      <a class="brand" href="/dashboard.html">
        <div class="logo"><i class="fa-solid fa-shield-heart"></i></div>
        <div>
          <div class="title">Plangecon • SESMT</div>
          <div class="subtitle">Notificação de Risco</div>
        </div>
      </a>
    </div>
  </header>

  <main class="container">
    <div class="back-container">
      <a href="/dashboard.html" class="btn-back"><i class="fas fa-arrow-left"></i> Voltar ao Painel Inicial</a>
    </div>

    <section class="form-card" aria-label="Formulário de Notificação">
      <h1>Formulário de Notificação/Interdição</h1>
      <p class="form-sub">Preencha os campos abaixo e, se necessário, anexe as evidências fotográficas.</p>
      <div class="divider"></div>

      <form id="formNotificacao" enctype="multipart/form-data" class="grid">
        <!-- Responsáveis -->
        <div class="grid grid-2">
          <div class="field">
            <label for="tecnico">Técnico Responsável</label>
            <div class="input"><i class="fa-solid fa-user-helmet-safety"></i>
              <select id="tecnico" name="tecnico" required>
                <option value="">Selecione...</option>
                <option>ALVARO MOREIRA DA COSTA</option>
                <option>Debora Nascimento de Freitas</option>
                <option>Diego Silva da Silva</option>
                <option>Douglas Leandro Silva Raposo</option>
                <option>Gleiciele Oliveira Rodrigues</option>
                <option>Jailton Pinto Pacheco Larroque</option>
                <option>Marcos Augusto Mendonca Goncalves</option>
                <option>Marinalva dos Santos da Masceno</option>
                <option>Patricia Matias de Albuquerque</option>
                <option>Rafael Silva Sousa</option>
                <option>Thalia Maia Fernandes</option>
                <option>Valmiran Eduardo Cardoso da Silva</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label for="encarregado">Encarregado Responsável</label>
            <div class="input"><i class="fa-solid fa-user-tie"></i>
              <select id="encarregado" name="encarregado" required>
                <option value="">Selecione...</option>
                <!-- opções omitidas por brevidade -->
                <option value="Wesley Oliveira da Silva">Wesley Oliveira da Silva</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Datas e classificação -->
        <div class="grid grid-3">
          <div class="field">
            <label for="data">Data da Notificação</label>
            <div class="input"><i class="fa-regular fa-calendar-days"></i>
              <input type="date" id="data" name="data" required />
            </div>
          </div>

          <div class="field">
            <label for="classificacao">Classificação</label>
            <div class="input"><i class="fa-solid fa-triangle-exclamation"></i>
              <select id="classificacao" name="classificacao" required>
                <option value="">Selecione</option>
                <option value="Notificação">Notificação</option>
                <option value="Interdição">Interdição</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label for="Squad">Squad</label>
            <div class="input"><i class="fa-solid fa-people-group"></i>
              <select id="Squad" name="Squad" required>
                <option value="">Selecione...</option>
                <option value="USINA I E II">USINA I E II</option>
                <option value="SALOBO III">SALOBO III</option>
                <option value="BRITAGEM">BRITAGEM</option>
                <option value="OFICINA CENTRALIZADA">OFICINA CENTRALIZADA</option>
                <option value="IGB">IGB</option>
                <option value="MINA">MINA</option>
                <option value="BARRAGEM">BARRAGEM</option>
                <option value="PAULO FONTELES">PAULO FONTELES</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Textos -->
        <div class="field">
          <label for="Atividade">Descrição da Atividade</label>
          <div class="input"><i class="fa-solid fa-clipboard-list"></i>
            <textarea id="Atividade" name="Atividade" rows="2" required placeholder="Ex.: Substituição de correia transportadora, área isolada e sinalizada..."></textarea>
          </div>
        </div>

        <div class="field">
          <label for="descricao">Descrição da Condição de Risco</label>
          <div class="input"><i class="fa-solid fa-file-lines"></i>
            <textarea id="descricao" name="descricao" rows="4" required placeholder="Explique o desvio de forma objetiva e com evidências."></textarea>
          </div>
        </div>

        <div class="field">
          <label for="nr">NR Relacionada</label>
          <div class="input"><i class="fa-solid fa-book-bookmark"></i>
            <select id="nr" name="nr" required>
              <option value="">Selecione...</option>
              <option>NR-1 - DISPOSIÇÕES GERAIS E GERENCIAMENTO DE RISCOS OCUPACIONAIS</option>
              <!-- demais opções -->
              <option>N/A</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label for="acao">Ações Recomendadas</label>
          <div class="input"><i class="fa-solid fa-list-check"></i>
            <textarea id="acao" name="acao" rows="3" required placeholder="Indique as ações corretivas/preventivas e responsáveis."></textarea>
          </div>
        </div>

        <div class="grid grid-2">
          <div class="field">
            <label for="prazo">Prazo para Resolução</label>
            <div class="input"><i class="fa-regular fa-clock"></i>
              <input type="date" id="prazo" name="prazo" required />
            </div>
          </div>
          <div class="field">
            <label for="fotos">Evidência Fotográfica (opcional)</label>
            <div class="dropzone" id="dropArea">
              <i class="fa-solid fa-cloud-arrow-up"></i>
              <span class="file-label">Selecione ou solte as imagens aqui</span>
              <span class="file-info" id="fileInfo">Nenhum arquivo selecionado</span>
              <input type="file" id="fotos" name="notificacaoFotos" multiple accept="image/*" />
            </div>
          </div>
        </div>

        <div class="actions">
          <button id="btnSubmit" class="btn" type="submit">
            <i class="fas fa-paper-plane"></i> Enviar Notificação
          </button>
        </div>
      </form>
    </section>
  </main>

  <!-- Overlay de Loading -->
  <div id="loading" class="loading" role="status" aria-live="polite" aria-label="Processando">
    <div class="loading-card">
      <i class="fa-solid fa-circle-notch fa-spin"></i>
      <span>Enviando e gerando PDF…</span>
    </div>
  </div>

  <!-- Toast de sucesso -->
  <div id="mensagemSucesso" class="alert" role="status" aria-live="polite">
    <span class="badge"><i class="fa-solid fa-check"></i> Enviado</span>
    <span>Notificação enviada com sucesso!</span>
    <a id="btnPdf" href="#" target="_blank"><i class="fas fa-file-pdf"></i> Baixar PDF</a>
  </div>

  <script>
    // --------- Submissão ----------
    const form = document.getElementById('formNotificacao');
    const alertBox = document.getElementById('mensagemSucesso');
    const btnPdf = document.getElementById('btnPdf');
    const loading = document.getElementById('loading');
    const btnSubmit = document.getElementById('btnSubmit');

    const fetchWithTimeout = (url, options = {}, ms = 45000) => {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), ms);
      const merged = { ...options, signal: controller.signal };
      return fetch(url, merged).finally(() => clearTimeout(id));
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // UI: busy on
      btnSubmit.setAttribute('aria-busy','true');
      const originalBtnHTML = btnSubmit.innerHTML;
      btnSubmit.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Enviando…';
      loading.classList.add('show');

      try {
        const fd = new FormData(form);
        const res = await fetchWithTimeout('/enviar', { method: 'POST', body: fd }, 90000);
        if (!res.ok) throw new Error('Falha na resposta do servidor');

        const { _id } = await res.json();
        btnPdf.href = `/notificacoes/${_id}/pdf`;

        // mostra toast
        alertBox.classList.add('show');
        setTimeout(() => alertBox.classList.remove('show'), 12000);
      } catch (err) {
        console.error(err);
        alert('Erro ao enviar ou tempo excedido. Tente novamente.');
      } finally {
        // UI: busy off
        loading.classList.remove('show');
        btnSubmit.removeAttribute('aria-busy');
        btnSubmit.innerHTML = originalBtnHTML;
      }
    });

    // --------- UX extra ----------
    // Pré-preencher data de hoje se vazio
    const dataInput = document.getElementById('data');
    if(!dataInput.value){
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      dataInput.value = `${yyyy}-${mm}-${dd}`;
    }
  </script>
</body>
</html>
