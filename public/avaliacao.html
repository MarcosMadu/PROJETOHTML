<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Avaliação 5S Tecnosonda — Auditoria</title>
  <style>
    :root{
      --bg:#f2f4f7;          /* cinza gelo */
      --card:#ffffff;
      --text:#101828;
      --muted:#667085;
      --border:#e4e7ec;
      --shadow: 0 10px 24px rgba(16,24,40,.08);
      --primary:#2563eb;
      --danger:#dc2626;
      --ok:#16a34a;
      --warn:#f59e0b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header{
      position: sticky; top:0; z-index:10;
      background: rgba(242,244,247,.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 18px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; flex-direction:column; gap:4px;
    }
    .brand h1{margin:0;font-size:18px;letter-spacing:.2px}
    .brand p{margin:0;color:var(--muted);font-size:12px}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 12px; border:1px solid var(--border); background:#fff;
      border-radius:999px; box-shadow: 0 4px 12px rgba(16,24,40,.04);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }

    main .wrap{padding-top:22px; padding-bottom:40px}

    .grid{
      display:grid; grid-template-columns: 1.2fr .8fr; gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:16px 16px 10px 16px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .card-h h2{margin:0;font-size:14px}
    .card-h .sub{margin:4px 0 0 0;font-size:12px;color:var(--muted)}
    .card-b{padding:16px}

    .meta{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px;
    }
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field input, .field select{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      outline:none;
      background:#fff;
    }
    .field input:focus, .field select:focus{
      border-color: rgba(37,99,235,.5);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .items{
      display:flex; flex-direction:column; gap:10px;
    }
    .item{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    .item-top{
      padding:12px 12px 10px 12px;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      cursor:pointer;
    }
    .item-left{display:flex; gap:10px; align-items:flex-start}
    .num{
      width:28px;height:28px;border-radius:10px;
      display:grid; place-items:center;
      border:1px solid var(--border);
      color:var(--muted); font-size:12px;
      background: #f8fafc;
      flex:0 0 auto;
    }
    .txt{min-width:0}
    .tag{
      display:inline-flex; padding:4px 8px; border-radius:999px;
      font-size:11px; border:1px solid var(--border);
      color:var(--muted); background:#fff;
      margin-bottom:6px;
    }
    .q{
      margin:0; font-size:13px; line-height:1.35;
      color: var(--text);
    }
    .chev{color:var(--muted); font-size:12px; padding-top:2px; flex:0 0 auto}

    .item-body{
      display:none;
      padding:12px;
      border-top:1px solid var(--border);
      background:#fbfcfe;
    }
    .item.open .item-body{display:block}

    .choices{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .radio{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#fff;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .radio input{margin:0}
    .note{font-size:12px;color:var(--muted);margin:0 0 10px 0}

    .panel{
      border:1px dashed rgba(102,112,133,.35);
      background:#fff;
      border-radius:14px;
      padding:12px;
      margin-top:10px;
    }
    .panel h4{margin:0 0 8px 0;font-size:12px;color:var(--text)}
    .panel .hint{margin:0 0 10px 0;font-size:12px;color:var(--muted)}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex: 1 1 220px}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border:1px solid transparent;
      padding:10px 12px; border-radius:12px;
      cursor:pointer; font-weight:600; font-size:13px;
      background: var(--primary); color:#fff;
      box-shadow: 0 10px 18px rgba(37,99,235,.18);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .btn.ghost{
      background:#fff; color:var(--text);
      border-color: var(--border);
      box-shadow:none;
      font-weight:600;
    }
    .btn.danger{
      background: var(--danger);
      box-shadow: 0 10px 18px rgba(220,38,38,.18);
    }
    .mini{
      padding:8px 10px; border-radius:10px; font-size:12px;
    }

    .deviation{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:10px;
      margin-top:10px;
    }
    .deviation .head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      font-size:11px; border:1px solid var(--border);
      color: var(--muted); background:#fff;
    }

    .footer-actions{
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      padding:14px 16px;
      border-top:1px solid var(--border);
      background: rgba(255,255,255,.7);
    }

    .alert{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:10px 12px;
      font-size:12px;
      color:var(--muted);
    }
    .alert strong{color:var(--text)}
    .loading{
      display:none; align-items:center; gap:10px;
      color:var(--muted); font-size:12px;
    }
    .loading.on{display:inline-flex}
    .dot{
      width:10px;height:10px;border-radius:999px;background:var(--primary);
      animation:pulse .9s infinite ease-in-out;
    }
    @keyframes pulse{
      0%,100%{transform:scale(.9);opacity:.6}
      50%{transform:scale(1.2);opacity:1}
    }

    /* ====== ADICIONADO: Card de maturidade ====== */
    .maturidade-card{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:12px;
      box-shadow: 0 10px 18px rgba(16,24,40,.06);
      margin-bottom:14px;
    }
    .maturidade-top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .maturidade-top h3{
      margin:0;
      font-size:13px;
      color:var(--text);
    }
    .maturidade-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:12px;
      color:var(--muted);
      background:#fff;
      white-space:nowrap;
    }
    .maturidade-pill.ok{border-color: rgba(22,163,74,.35); color: var(--ok); background: rgba(22,163,74,.06)}
    .maturidade-pill.warn{border-color: rgba(245,158,11,.35); color:var(--warn); background: rgba(245,158,11,.08)}
    .maturidade-pill.danger{border-color: rgba(220,38,38,.35); color: var(--danger); background: rgba(220,38,38,.06)}
    .maturidade-body{
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      color:var(--text);
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <h1>Avaliação 5S Tecnosonda</h1>
          <p>Auditoria semanal — Conforme / Não Conforme / Não Aplica</p>
        </div>
        <div class="pill" id="pillSemana">Semana: <strong id="semanaId">—</strong> · Auditor: <strong id="auditorSemana">—</strong></div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="grid">

        <!-- Checklist -->
        <section class="card">
          <div class="card-h">
            <div>
              <h2>Checklist</h2>
              <p class="sub">C e NC exigem foto. NA exige justificativa. NC permite múltiplos desvios (1 foto = 1 desvio com responsável).</p>
            </div>
            <button class="btn ghost mini" id="btnExpandir">Expandir tudo</button>
          </div>

          <div class="card-b">
            <div class="items" id="listaItens"></div>

            <div class="alert">
              <strong>Validação:</strong> você só consegue enviar quando todos os itens tiverem status definido e as evidências obrigatórias estiverem anexadas.
            </div>
          </div>

          <div class="footer-actions">
            <span class="loading" id="loadingEnvio"><span class="dot"></span>Enviando inspeção...</span>
            <button class="btn" id="btnEnviar">Enviar auditoria</button>
          </div>
        </section>

        <!-- Metadados -->
        <aside class="card">
          <div class="card-h">
            <div>
              <h2>Informações do registro</h2>
              <p class="sub">Semana e auditor são automáticos (alterável no gestor).</p>
            </div>
          </div>

          <div class="card-b">

            <!-- ====== ADICIONADO: Card de Maturidade ====== -->
            <div class="maturidade-card" id="maturidadeCard">
              <div class="maturidade-top">
                <h3>Maturidade 5S (automática)</h3>
                <span class="maturidade-pill warn" id="maturidadePill">
                  Maturidade: <strong id="maturidadeValor">—</strong>
                </span>
              </div>
              <div class="maturidade-body" id="maturidadeBody">
                Preencha os status dos itens para calcular a maturidade.
              </div>
            </div>

            <div class="meta">
              <div class="field">
                <label>Data/Hora</label>
                <input id="dataHora" type="text" readonly />
              </div>
              <div class="field">
                <label>ID (gerado no envio)</label>
                <input id="auditoriaId" type="text" placeholder="—" readonly />
              </div>
              <div class="field" style="grid-column:1 / -1;">
                <label>Área / Setor (opcional)</label>
                <input id="setor" type="text" placeholder="Ex.: Pátio / Sonda / Almoxarifado..." />
              </div>
            </div>

            <div class="alert" style="margin-top:14px">
              <strong>Obs.:</strong> Agora está conectado ao backend para buscar semana/auditor e salvar no MongoDB (agora com upload real de fotos no Cloudinary).
            </div>
          </div>
        </aside>

      </div>
    </div>
  </main>

  <script>
    // Lista real (auditor automático e responsável da tratativa)
    const RESPONSAVEIS = [
      "Selecione...",
      "ALLAN DO NASCIMENTO MORAES",
      "ANDRE DA CONCEICAO ALVES",
      "ANGLA RAKEL SILVA ALMEIDA",
      "ANTONY CHE GUEVARA CAVALCANTE DOS SANTOS",
      "CLEITON DE PAULA BATISTA",
      "DEIVIANE CONCEICAO PEREIRA",
      "EDUARDO DE SOUSA",
      "FERNANDO QUEIROZ DA SILVA",
      "HELIO BARBOSA DOS SANTOS",
      "HERACLITO HENRIQUE SANTANA LOPES",
      "JANAINA KETLEY ANDRADE RIBEIRO",
      "JEOVANE DOS SANTOS SILVA",
      "JORGE MOUZINHO CARVALHO",
      "LUCRECIA SANTOS DO NASCIMENTO",
      "LUIS ANTONIO FELIX DE VASCONCELLOS",
      "MARCELO MONTANDON MARCAL JUNIOR",
      "MARCOS OLIVEIRA MENEZES",
      "RAFAEL HENRIQUE ALVES RIBEIRO",
      "RAPHAEL JOSE PEREIRA DA SILVA",
      "RODRIGO BARBOSA DA SILVA",
      "MARCOS VINICUS BATISTA RIBEIRO",
      "TAINARA BERTUNES DOS SANTOS",
      "VERONICA LUIZA GOMES DE MENEZES",
      "WILDSON DA SILVA BARROS"
    ];

    // Itens (15) com grupos por faixa de maturidade
    const ITENS = [
      { id: 1,  grupo: "Maturidade 1", texto: "A área está livre de objetos obsoletos, improvisados ou sucateados, sem identificação?" },
      { id: 2,  grupo: "Maturidade 1", texto: "A área está limpa, sem resíduos espalhados pelo chão?" },
      { id: 3,  grupo: "Maturidade 1", texto: "Existem recipientes/coletores para acondicionamento de resíduos e os mesmos encontram-se identificados?" },
      { id: 4,  grupo: "Maturidade 1", texto: "Os banheiros e vestiários encontram-se limpos e organizados? Possui todos recursos básicos disponíveis e identificação de gênero?" },
      { id: 5,  grupo: "Maturidade 1", texto: "Os equipamentos e mobiliário estão isentos de sujeiras ou acúmulo de materiais?" },
      { id: 6,  grupo: "Maturidade 1", texto: "Os ventiladores, exaustores, ar-condicionado, janelas ou saídas de ar estão perfeitamente limpas? Existe cronograma visual de limpeza?" },
      { id: 7,  grupo: "Maturidade 1", texto: "Área de passagem está desobstruída e em boas condições?" },

      { id: 8,  grupo: "Maturidade 2", texto: "O layout das salas administrativas, está organizado, permitindo fluidez na circulação entre as pessoas pelos postos de trabalho?" },
      { id: 9,  grupo: "Maturidade 2", texto: "A fiação visível dos computadores e equipamentos, estão dispostos de forma organizada e segura?" },
      { id: 10, grupo: "Maturidade 2", texto: "Existem referências visuais de organização (condição normal esperada)?" },
      { id: 11, grupo: "Maturidade 2", texto: "Existe mapa, rota de fuga e local de encontro definidos e disponíveis?" },

      { id: 12, grupo: "Maturidade 3", texto: "Somente os materiais ou objetos essenciais estão disponíveis nas frentes de trabalho, mesas e escritório?" },
      { id: 13, grupo: "Maturidade 3", texto: "Itens estão localizados em sua área demarcada/identificada ou organizados conforme referências normais x anormais?" },
      { id: 14, grupo: "Maturidade 3", texto: "Após a jornada de trabalho ou final da utilização do espaço, o padrão de organização se mantém?" },

      { id: 15, grupo: "Maturidade 4", texto: "A área é referência de 5S para outras áreas? Possui pelo menos três meses consecutivos de notas de maturidade igual ou superior a 3?" }
    ];

    // Estado em memória
    const state = new Map(); // itemId -> { status, naJustificativa, conformeFotos: File[], desvios: [{foto:File, responsavel}] }

    function nowBR(){
      const d = new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    async function initSemanaMock(){
      try{
        const res = await fetch("/api/5s/semana-atual");
        if(!res.ok) throw new Error("Falha ao buscar semana atual.");
        const data = await res.json();
        document.getElementById("semanaId").textContent = data.semanaId || "—";
        document.getElementById("auditorSemana").textContent = data.auditorSemana || "—";
      }catch(e){
        document.getElementById("semanaId").textContent = "erro";
        document.getElementById("auditorSemana").textContent = "erro";
      }
    }

    function buildResponsaveisOptions(selected="Selecione..."){
      return RESPONSAVEIS.map(n => `<option value="${escapeHtml(n)}" ${n===selected?'selected':''}>${escapeHtml(n)}</option>`).join("");
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function ensureItemState(itemId){
      if(!state.has(itemId)){
        state.set(itemId, { status: null, naJustificativa:"", conformeFotos: [], desvios: [] });
      }
      return state.get(itemId);
    }

    /* ====== ADICIONADO: cálculo de maturidade ====== */
    function getItemById(id){
      return ITENS.find(x => x.id === id);
    }

    function statusLabel(s){
      if(s === "C") return "C (Conforme)";
      if(s === "NC") return "NC (Não Conforme)";
      if(s === "NA") return "NA (Não Aplica)";
      return "—";
    }

    function itemAtende(status){
  // “Atende” = C | “Neutro” = NA (não derruba) | “Não atende” = NC
  if(status === "NA") return true;
  return status === "C";
    }


    function allHaveStatus(){
      return ITENS.every(it => {
        const st = ensureItemState(it.id);
        return !!st.status;
      });
    }

    function computeMaturidade(){
      // Se ainda tem item sem status, mostramos pendente
      if(!allHaveStatus()){
        return {
          ready: false,
          maturidade: null,
          regra: "Preencha os itens para calcular.",
          derrubou: null
        };
      }

      // Faixas:
      const m1 = [1,2,3,4,5,6,7];
      const m2 = [8,9,10,11];
      const m3 = [12,13,14];
      const m4 = [15];

      // 1) Se qualquer item 1-7 NÃO atender => maturidade 0
      for(const id of m1){
        const st = ensureItemState(id);
        if(!itemAtende(st.status)){
          const it = getItemById(id);
          return {
            ready: true,
            maturidade: 0,
            regra: "Itens 1–7 (Maturidade 1): se algum NÃO atender → maturidade 0.",
            derrubou: { id, status: st.status, texto: it?.texto || "" }
          };
        }
      }

      // 2) Itens 8-11: se algum NÃO atender => maturidade 1
      for(const id of m2){
        const st = ensureItemState(id);
        if(!itemAtende(st.status)){
          const it = getItemById(id);
          return {
            ready: true,
            maturidade: 1,
            regra: "Itens 8–11 (Maturidade 2): se algum NÃO atender → maturidade 1.",
            derrubou: { id, status: st.status, texto: it?.texto || "" }
          };
        }
      }

      // 3) Itens 12-14: se algum NÃO atender => maturidade 2
      for(const id of m3){
        const st = ensureItemState(id);
        if(!itemAtende(st.status)){
          const it = getItemById(id);
          return {
            ready: true,
            maturidade: 2,
            regra: "Itens 12–14 (Maturidade 3): se algum NÃO atender → maturidade 2.",
            derrubou: { id, status: st.status, texto: it?.texto || "" }
          };
        }
      }

      // 4) Item 15: se NÃO atender => maturidade 3; se atender => 4
      for(const id of m4){
        const st = ensureItemState(id);
        const it = getItemById(id);
        if(!itemAtende(st.status)){
          return {
            ready: true,
            maturidade: 3,
            regra: "Item 15 (Maturidade 4): se NÃO atender → maturidade 3; se atender → 4.",
            derrubou: { id, status: st.status, texto: it?.texto || "" }
          };
        }
      }

      // Se chegou aqui, tudo atende até o 15 => 4
      return {
        ready: true,
        maturidade: 4,
        regra: "Todos itens atendidos (C) nas faixas 1–7, 8–11, 12–14 e item 15 → maturidade 4.",
        derrubou: null
      };
    }

    function updateMaturidadeCard(){
      const pill = document.getElementById("maturidadePill");
      const v = document.getElementById("maturidadeValor");
      const body = document.getElementById("maturidadeBody");

      const r = computeMaturidade();

      if(!r.ready){
        v.textContent = "—";
        pill.classList.remove("ok","danger");
        pill.classList.add("warn");
        body.innerHTML = `Preencha os status dos itens para calcular a maturidade.`;
        return;
      }

      v.textContent = String(r.maturidade);

      // cor da pill (simples e útil)
      pill.classList.remove("ok","warn","danger");
      if(r.maturidade >= 3) pill.classList.add("ok");
      else if(r.maturidade === 2) pill.classList.add("warn");
      else pill.classList.add("danger");

      if(r.derrubou){
        body.innerHTML = `
          <div><strong>Regra aplicada:</strong> ${escapeHtml(r.regra)}</div>
          <div style="margin-top:8px">
            <strong>Item que derrubou:</strong>
            <span class="mono">#${escapeHtml(r.derrubou.id)}</span>
            (${escapeHtml(statusLabel(r.derrubou.status))})
          </div>
          <div style="margin-top:6px">
            <strong>Pergunta:</strong> ${escapeHtml(r.derrubou.texto || "—")}
          </div>
          <div style="margin-top:10px">
            <strong>Legenda:</strong> 0=inexistente · 1=fraco · 2=em implantação · 3=implantado · 4=excelência
          </div>
        `;
      }else{
        body.innerHTML = `
          <div><strong>Regra aplicada:</strong> ${escapeHtml(r.regra)}</div>
          <div style="margin-top:10px">
            <strong>Legenda:</strong> 0=inexistente · 1=fraco · 2=em implantação · 3=implantado · 4=excelência
          </div>
        `;
      }
    }

    function render(){
      const container = document.getElementById("listaItens");
      container.innerHTML = "";

      ITENS.forEach((it, idx) => {
        const st = ensureItemState(it.id);

        const el = document.createElement("div");
        el.className = "item";
        el.dataset.itemId = it.id;

        el.innerHTML = `
          <div class="item-top" role="button" aria-expanded="false">
            <div class="item-left">
              <div class="num">${idx+1}</div>
              <div class="txt">
                <div class="tag">${escapeHtml(it.grupo)}</div>
                <p class="q">${escapeHtml(it.texto)}</p>
              </div>
            </div>
            <div class="chev">▼</div>
          </div>

          <div class="item-body">
            <div class="choices">
              <label class="radio">
                <input type="radio" name="status-${it.id}" value="C" ${st.status==="C"?"checked":""}/>
                Conforme (C)
              </label>
              <label class="radio">
                <input type="radio" name="status-${it.id}" value="NC" ${st.status==="NC"?"checked":""}/>
                Não Conforme (NC)
              </label>
              <label class="radio">
                <input type="radio" name="status-${it.id}" value="NA" ${st.status==="NA"?"checked":""}/>
                Não Aplica (NA)
              </label>
            </div>

            <p class="note" id="note-${it.id}">${getNoteText(st.status)}</p>

            <div id="panel-${it.id}"></div>
          </div>
        `;

        // toggle
        el.querySelector(".item-top").addEventListener("click", () => {
          const open = el.classList.toggle("open");
          el.querySelector(".item-top").setAttribute("aria-expanded", String(open));
          el.querySelector(".chev").textContent = open ? "▲" : "▼";
        });

        // status change
        el.querySelectorAll(`input[name="status-${it.id}"]`).forEach(r => {
          r.addEventListener("change", (e) => {
            st.status = e.target.value;
            if(st.status !== "NA") st.naJustificativa = "";
            if(st.status !== "C") st.conformeFotos = [];
            if(st.status !== "NC") st.desvios = [];
            updateItemPanel(it.id);
            el.querySelector(`#note-${it.id}`).textContent = getNoteText(st.status);

            // ====== ADICIONADO: atualizar maturidade ao mudar status ======
            updateMaturidadeCard();
          });
        });

        container.appendChild(el);
        updateItemPanel(it.id);
      });

      // ====== ADICIONADO: atualizar maturidade após render inicial ======
      updateMaturidadeCard();
    }

    function getNoteText(status){
      if(status==="C") return "Foto obrigatória (evidência do item).";
      if(status==="NC") return "Foto obrigatória por desvio + responsável obrigatório por cada foto. Você pode adicionar várias NCs (vários desvios) no mesmo item.";
      if(status==="NA") return "Justificativa obrigatória para 'Não Aplica'.";
      return "Selecione um status para este item.";
    }

    function updateItemPanel(itemId){
      const st = ensureItemState(itemId);
      const panel = document.querySelector(`#panel-${CSS.escape(itemId)}`);
      if(!panel) return;

      if(!st.status){
        panel.innerHTML = "";
        return;
      }

      if(st.status === "NA"){
        panel.innerHTML = `
          <div class="panel">
            <h4>Justificativa (obrigatória)</h4>
            <p class="hint">Explique por que este item não se aplica.</p>
            <div class="row">
              <div class="field" style="flex:1 1 100%">
                <input type="text" id="na-${itemId}" placeholder="Digite a justificativa..." value="${escapeHtml(st.naJustificativa)}"/>
              </div>
            </div>
          </div>
        `;
        panel.querySelector(`#na-${CSS.escape(itemId)}`).addEventListener("input", (e)=>{
          st.naJustificativa = e.target.value;
          // (opcional) NA não atende, mas a maturidade já muda por status
        });
        return;
      }

      if(st.status === "C"){
        panel.innerHTML = `
          <div class="panel">
            <h4>Evidência do item (foto obrigatória)</h4>
            <p class="hint">Anexe pelo menos 1 foto do item conforme.</p>
            <div class="row">
              <div class="field" style="flex:1 1 100%">
                <input type="file" id="cf-${itemId}" accept="image/*" />
              </div>
            </div>
            <div class="hint" id="cfcount-${itemId}">${st.conformeFotos.length ? `Fotos anexadas: ${st.conformeFotos.length}` : "Nenhuma foto anexada ainda."}</div>
          </div>
        `;
        panel.querySelector(`#cf-${CSS.escape(itemId)}`).addEventListener("change", (e)=>{
          const files = Array.from(e.target.files || []);
          st.conformeFotos = files;
          updateItemPanel(itemId);
        });
        return;
      }

      // NC
      const desviosHtml = st.desvios.map((d, i) => `
        <div class="deviation">
          <div class="head">
            <span class="badge">Desvio #${i+1}</span>
            <button class="btn danger mini" type="button" data-rm="${i}">Remover</button>
          </div>
          <div class="row">
            <div class="field">
              <label>Foto do desvio (obrigatória)</label>
              <input type="file" accept="image/*" data-foto="${i}" />
              <div class="hint">${d.foto ? `Anexada: ${escapeHtml(d.foto.name)}` : "Nenhuma foto anexada."}</div>
            </div>
            <div class="field">
              <label>Responsável pela tratativa (obrigatório)</label>
              <select data-resp="${i}">
                ${buildResponsaveisOptions(d.responsavel || "Selecione...")}
              </select>
            </div>
          </div>
        </div>
      `).join("");

      panel.innerHTML = `
        <div class="panel">
          <h4>Não Conformidade (NC) — Desvios</h4>
          <p class="hint">Cada foto = 1 desvio. Para cada desvio, selecione um responsável. O mesmo responsável pode aparecer em vários desvios.</p>

          <button class="btn ghost mini" type="button" id="add-${itemId}">+ Adicionar nova NC (novo desvio)</button>

          <div id="desvios-${itemId}">
            ${desviosHtml || `<div class="alert"><strong>Sem desvios ainda.</strong> Clique em “Adicionar nova NC”.</div>`}
          </div>
        </div>
      `;

      panel.querySelector(`#add-${CSS.escape(itemId)}`).addEventListener("click", ()=>{
        st.desvios.push({ foto:null, responsavel:"Selecione..." });
        updateItemPanel(itemId);
      });

      panel.querySelectorAll("[data-rm]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const idx = Number(btn.getAttribute("data-rm"));
          st.desvios.splice(idx, 1);
          updateItemPanel(itemId);
        });
      });

      panel.querySelectorAll("[data-foto]").forEach(inp=>{
        inp.addEventListener("change", (e)=>{
          const i = Number(inp.getAttribute("data-foto"));
          const file = (e.target.files || [])[0] || null;
          st.desvios[i].foto = file;
          updateItemPanel(itemId);
        });
      });

      panel.querySelectorAll("[data-resp]").forEach(sel=>{
        sel.addEventListener("change", ()=>{
          const i = Number(sel.getAttribute("data-resp"));
          st.desvios[i].responsavel = sel.value;
        });
      });
    }

    function validateAll(){
      const errors = [];

      ITENS.forEach(it=>{
        const st = ensureItemState(it.id);
        if(!st.status){
          errors.push(`Item ${it.id}: selecione Conforme/NC/NA.`);
          return;
        }
        if(st.status === "NA"){
          if(!st.naJustificativa.trim()){
            errors.push(`Item ${it.id}: justificativa obrigatória (Não Aplica).`);
          }
        }
        if(st.status === "C"){
          if(!st.conformeFotos || st.conformeFotos.length === 0){
            errors.push(`Item ${it.id}: foto obrigatória (Conforme).`);
          }
        }
        if(st.status === "NC"){
          if(!st.desvios || st.desvios.length === 0){
            errors.push(`Item ${it.id}: adicione ao menos 1 desvio (foto).`);
          } else {
            st.desvios.forEach((d, idx)=>{
              if(!d.foto) errors.push(`Item ${it.id} (Desvio #${idx+1}): foto obrigatória.`);
              if(!d.responsavel || d.responsavel === "Selecione...") errors.push(`Item ${it.id} (Desvio #${idx+1}): responsável obrigatório.`);
            });
          }
        }
      });

      return errors;
    }

    // buildPayload com fieldnames batendo com os arquivos
    function buildPayloadWithFields(){
      const itens = ITENS.map(it=>{
        const st = ensureItemState(it.id);

        return {
          itemId: it.id,
          grupo: it.grupo,
          texto: it.texto,
          status: st.status,
          naJustificativa: st.status==="NA" ? st.naJustificativa : null,

          conformeFotos: st.status==="C"
            ? (st.conformeFotos || []).map((f, idx)=>({
                field: `conf_${it.id}_${idx}`,
                name: f.name,
                size: f.size,
                type: f.type
              }))
            : [],

          desvios: st.status==="NC"
            ? (st.desvios || []).map((d, idx)=>({
                responsavel: d.responsavel,
                foto: d.foto
                  ? {
                      field: `nc_${it.id}_${idx}`,
                      name: d.foto.name,
                      size: d.foto.size,
                      type: d.foto.type
                    }
                  : null
              }))
            : []
        };
      });

      return {
        semanaId: document.getElementById("semanaId").textContent,
        auditorSemana: document.getElementById("auditorSemana").textContent,
        dataHora: document.getElementById("dataHora").value,
        setor: document.getElementById("setor").value || null,
        itens
      };
    }

    // Eventos
    document.getElementById("btnExpandir").addEventListener("click", ()=>{
      const items = document.querySelectorAll(".item");
      const anyClosed = Array.from(items).some(i=>!i.classList.contains("open"));
      items.forEach(i=>{
        i.classList.toggle("open", anyClosed);
        i.querySelector(".chev").textContent = anyClosed ? "▲" : "▼";
        i.querySelector(".item-top").setAttribute("aria-expanded", String(anyClosed));
      });
      document.getElementById("btnExpandir").textContent = anyClosed ? "Recolher tudo" : "Expandir tudo";
    });

    // ENVIO
    document.getElementById("btnEnviar").addEventListener("click", async ()=>{
      const btn = document.getElementById("btnEnviar");
      const loading = document.getElementById("loadingEnvio");

      const errs = validateAll();
      if(errs.length){
        alert("Corrija antes de enviar:\n\n- " + errs.join("\n- "));
        return;
      }

      btn.disabled = true;
      loading.classList.add("on");

      try{
        const fd = new FormData();

        // anexar arquivos reais
        ITENS.forEach((it) => {
          const st = ensureItemState(it.id);

          if(st.status === "C"){
            (st.conformeFotos || []).forEach((file, idx)=>{
              fd.append(`conf_${it.id}_${idx}`, file);
            });
          }

          if(st.status === "NC"){
            (st.desvios || []).forEach((d, idx)=>{
              if(d.foto) fd.append(`nc_${it.id}_${idx}`, d.foto);
            });
          }
        });

        const payload = buildPayloadWithFields();
        fd.append("payload", JSON.stringify(payload));

        const res = await fetch("/api/5s/auditorias", {
          method:"POST",
          body: fd
        });

        if(!res.ok){
          const txt = await res.text().catch(()=> "");
          throw new Error(txt || "Falha ao enviar auditoria.");
        }

        const data = await res.json().catch(()=> ({}));
        document.getElementById("auditoriaId").value = data.auditoriaId || "OK";
        alert("Auditoria enviada com sucesso!");
      }catch(err){
        alert("Erro ao enviar: " + (err?.message || err));
      }finally{
        btn.disabled = false;
        loading.classList.remove("on");
      }
    });

    // Init
    document.getElementById("dataHora").value = nowBR();
    initSemanaMock();
    render();
  </script>
</body>
</html>
